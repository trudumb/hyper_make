Unified Adverse Selection Framework — Implementation Plan (8 Phases)                                                                                                                                                     │
│                                                                                                                                                                                                                          │
│ Context                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ The MM accumulated +6.94 long position during a bearish trend on Feb 19, losing $0.84. The drift estimator detected the selloff 9 minutes before bids were pulled, but six decoupled protective subsystems failed to     │
│ act: drift was capped at ±3 bps, signal_weight was stuck at 0.0, toxicity reduced size by only 3-17%, the quote gate waited for 50% inventory before acting, and position zones created discrete behavioral jumps.       │
│                                                                                                                                                                                                                          │
│ The RFC (docs/rfc_unified_adverse_selection_framework.md) replaces all six with a unified system of 8 components where every quoting decision flows from per-level expected PnL. This plan implements the RFC in 8       │
│ phases.                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ What Gets Replaced                                                                                                                                                                                                       │
│                                                                                                                                                                                                                          │
│ ┌─────────────────────────┬───────────────────────────────────────────┬────────────────────────────────────────────────────────┐                                                                                         │
│ │        Subsystem        │                 Location                  │                      Failure Mode                      │                                                                                         │
│ ├─────────────────────────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────┤                                                                                         │
│ │ drift_adj_bps ±3 clamp  │ ladder_strat.rs:1257                      │ Caps drift to 1 tick — meaningless on 5 bps spread     │                                                                                         │
│ ├─────────────────────────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────┤                                                                                         │
│ │ toxicity_size_mult      │ ladder_strat.rs:1643                      │ 3-17% size reduction — cosmetic                        │                                                                                         │
│ ├─────────────────────────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────┤                                                                                         │
│ │ Binary quote gate       │ quote_gate.rs:1174 → quote_engine.rs:2467 │ NoQuote/OnlyBids/OnlyAsks at 50%+ inventory — too late │                                                                                         │
│ ├─────────────────────────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────┤                                                                                         │
│ │ Discrete position zones │ ladder_strat.rs:1022-1044,1278-1305       │ Green/Yellow/Red/Kill jumps at 60/80/100%              │                                                                                         │
│ ├─────────────────────────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────┤                                                                                         │
│ │ Dead signal_weight      │ quote_gate.rs:1822                        │ Stuck at 0.0 — trend detector disconnected from gate   │                                                                                         │
│ ├─────────────────────────┼───────────────────────────────────────────┼────────────────────────────────────────────────────────┤                                                                                         │
│ │ Dead smoothed_drift     │ quote_engine.rs:644                       │ EWMA never warms up — logged but never acts            │                                                                                         │
│ └─────────────────────────┴───────────────────────────────────────────┴────────────────────────────────────────────────────────┘                                                                                         │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 1: Kalman Drift Estimator + Remove ±3 Cap                                                                                                                                                                          │
│                                                                                                                                                                                                                          │
│ Goal: Replace batch conjugate DriftEstimator with Kalman filter using OU mean-reversion. Remove the ±3 bps drift clamp. This alone would have prevented most Feb 19 damage.                                              │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/strategy/drift_estimator.rs — REWRITE                                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ Replace DriftEstimator (conjugate normal, 0.9× decay) with KalmanDriftEstimator:                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ pub struct KalmanDriftEstimator {                                                                                                                                                                                        │
│     state_mean: f64,         // Posterior μ̂ (bps/sec)                                                                                                                                                                   │
│     state_variance: f64,     // Posterior P                                                                                                                                                                              │
│     theta: f64,              // OU mean-reversion rate (1/sec), ~0.02 = 35s half-life                                                                                                                                    │
│     process_noise: f64,      // σ_μ² (bps²/sec³), calibration target                                                                                                                                                     │
│     prior_variance: f64,     // Initial P = σ_μ²/(2θ) (stationary variance)                                                                                                                                              │
│     last_update_ms: u64,                                                                                                                                                                                                 │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ // Predict (every cycle): μ̂⁻ = μ̂·exp(-θΔt), P⁻ = P·exp(-2θΔt) + Q(Δt)                                                                                                                                                  │
│ // Update (per observation): K = P⁻/(P⁻+R), μ̂ = μ̂⁻ + K(z-μ̂⁻), P = (1-K)P⁻                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ impl KalmanDriftEstimator {                                                                                                                                                                                              │
│     fn new(theta: f64, process_noise: f64) -> Self;                                                                                                                                                                      │
│     fn predict(&mut self, now_ms: u64);  // OU propagation                                                                                                                                                               │
│     fn update(&mut self, signals: &[SignalObservation], now_ms: u64);  // Kalman update                                                                                                                                  │
│     fn update_fill(&mut self, is_buy: bool, fill_price: f64, mid: f64, sigma: f64);                                                                                                                                      │
│     fn update_trend(&mut self, magnitude: f64, agreement: f64, p_continuation: f64);                                                                                                                                     │
│     fn drift_rate_per_sec(&self) -> f64;  // μ̂/10000 (fractional)                                                                                                                                                       │
│     fn drift_bps_per_sec(&self) -> f64;   // μ̂ (for logging)                                                                                                                                                            │
│     fn drift_uncertainty_bps(&self) -> f64; // √P                                                                                                                                                                        │
│     fn drift_confidence(&self) -> f64;    // 1 - P/P₀                                                                                                                                                                    │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Key differences from current DriftEstimator:                                                                                                                                                                             │
│ - Explicit predict step with OU dynamics (drift decays toward 0 between cycles, not ad-hoc 0.9×)                                                                                                                         │
│ - Fill observations: bid fill → bearish signal z = -(mid - fill_price) / σ                                                                                                                                               │
│ - Trend observations: z = -magnitude × agreement × p_continuation, R = σ_trend² / agreement²                                                                                                                             │
│ - No drift cap — uncertainty P naturally bounds the estimate                                                                                                                                                             │
│ - Generic update_observation(z, R) method for future feature pipeline (Phases 7-8)                                                                                                                                       │
│ - P_min floor (default 2.0 bps²) prevents overconfidence when many features feed the filter (Phases 7-8). See Phase 7 design note.                                                                                       │
│                                                                                                                                                                                                                          │
│ Parameters: theta=0.02 (35s half-life), process_noise=1.0, prior_variance=50.0. Note: stationary variance = σ_μ²/(2θ) = 1.0/0.04 = 25.0. We deliberately initialize at 2× stationary (P₀=50) for faster cold-start       │
│ reactivity — higher P means larger Kalman gain on first observations, so the filter locks onto the true drift faster. After ~20s of observations P will naturally decay toward 25. All in RiskConfig with                │
│ #[serde(default)].                                                                                                                                                                                                       │
│                                                                                                                                                                                                                          │
│ Keep old DriftEstimator as LegacyDriftEstimator for feature-gate rollback.                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/strategy/ladder_strat.rs:1252-1272 — REMOVE drift clamp                                                                                                                                              │
│                                                                                                                                                                                                                          │
│ Remove the entire drift_adj_bps clamp block. Drift is already applied by half_spread_with_drift() in glft.rs:969-971. The ladder_strat was double-applying AND capping it.                                               │
│                                                                                                                                                                                                                          │
│ Replace with monitoring log:                                                                                                                                                                                             │
│ let drift_adj_bps = market_params.drift_rate_per_sec * time_horizon * 10_000.0 / 2.0;                                                                                                                                    │
│ if drift_adj_bps.abs() > 3.0 {                                                                                                                                                                                           │
│     tracing::info!(drift_adj_bps, drift_uncertainty = market_params.drift_uncertainty_bps,                                                                                                                               │
│         "Drift exceeds old ±3 cap (now unclamped via Kalman)");                                                                                                                                                          │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ C. src/market_maker/mod.rs:378 — Type change                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ drift_estimator: DriftEstimator → drift_estimator: KalmanDriftEstimator                                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ D. src/market_maker/orchestrator/quote_engine.rs:522-590 — Wire predict/update                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ // Predict step (every cycle)                                                                                                                                                                                            │
│ self.drift_estimator.predict(now_ms);                                                                                                                                                                                    │
│ // Collect observations (existing signal code stays)                                                                                                                                                                     │
│ // Update step                                                                                                                                                                                                           │
│ if !drift_signals.is_empty() {                                                                                                                                                                                           │
│     self.drift_estimator.update(&drift_signals, now_ms);                                                                                                                                                                 │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Wire fills into drift estimator in handlers.rs: drift_estimator.update_fill(is_buy, fill_price, mid, sigma).                                                                                                             │
│ Wire trend updates: drift_estimator.update_trend(magnitude, agreement, p_continuation).                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ E. src/market_maker/strategy/market_params.rs — Add field                                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ #[serde(default)]                                                                                                                                                                                                        │
│ pub drift_uncertainty_bps: f64,  // Kalman posterior √P for logging                                                                                                                                                      │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_kalman_predict_decays_toward_zero — After predict without update, μ̂ → 0 with rate θ                                                                                                                              │
│ - test_kalman_update_moves_toward_observation — Single observation shifts μ̂ proportional to Kalman gain                                                                                                                 │
│ - test_kalman_fill_observation_bearish — Bid fill produces negative drift adjustment                                                                                                                                     │
│ - test_kalman_trend_observation_high_agreement — agreement=1.0 produces low-noise observation (large update)                                                                                                             │
│ - test_drift_unclamped_exceeds_3bps — Strong drift signal produces > 3 bps asymmetry                                                                                                                                     │
│ - test_no_signals_decays_via_ou — Without signals, drift decays to 0 via OU (not stuck)                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 2: Continuous γ(q) — Replace Discrete Position Zones                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ Goal: Replace Green/Yellow/Red/Kill zones with smooth γ(q) = γ_base × (1 + β(q/q_max)²).                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ Key Insight: Already Partially Implemented                                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ compute_legacy_gamma() at glft.rs:497 already has inventory_scalar = 1.0 + utilization² × 3.0. The RFC just needs β increased to absorb zone widening effects, and the discrete zone system removed from ladder_strat.   │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/strategy/glft.rs:497 — Increase β                                                                                                                                                                    │
│                                                                                                                                                                                                                          │
│ // OLD: let inventory_scalar = 1.0 + utilization.powi(2) * 3.0;                                                                                                                                                          │
│ // NEW: Absorbs discrete zone widening into smooth gamma curve                                                                                                                                                           │
│ let inventory_beta = self.risk_config.inventory_beta; // default 7.0                                                                                                                                                     │
│ let inventory_scalar = 1.0 + inventory_beta * utilization.powi(2);                                                                                                                                                       │
│                                                                                                                                                                                                                          │
│ At β=7.0: 60%→3.52×, 80%→4.92×, 100%→8.0× (vs old: Yellow→spread_mult 1.5, Red→spread_mult 2.0+10bps)                                                                                                                    │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/strategy/risk_config.rs — Add parameter                                                                                                                                                              │
│                                                                                                                                                                                                                          │
│ #[serde(default = "default_inventory_beta")]                                                                                                                                                                             │
│ pub inventory_beta: f64,  // default 7.0                                                                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ C. src/market_maker/strategy/ladder_strat.rs:1022-1054,1278-1305 — Remove zone system                                                                                                                                    │
│                                                                                                                                                                                                                          │
│ Remove:                                                                                                                                                                                                                  │
│ 1. Zone classification block (lines 1022-1054): let position_zone = if abs_inventory_ratio >= 1.0 { Kill } ...                                                                                                           │
│ 2. Zone spread widening block (lines 1278-1305): zone_spread_widen_bps application and side-clearing                                                                                                                     │
│                                                                                                                                                                                                                          │
│ Keep: Kill-switch position guard at utilization > 100% as standalone safety:                                                                                                                                             │
│ if abs_inventory_ratio >= 1.0 {                                                                                                                                                                                          │
│     if position > 0.0 { dynamic_depths.bid.clear(); }                                                                                                                                                                    │
│     else { dynamic_depths.ask.clear(); }                                                                                                                                                                                 │
│     tracing::warn!(position, "Kill-switch: clearing accumulating side at >100% utilization");                                                                                                                            │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ D. src/market_maker/risk/inventory_governor.rs — Keep for diagnostics                                                                                                                                                    │
│                                                                                                                                                                                                                          │
│ PositionZone enum and assess() stay for logging/alerting. No longer drives quoting.                                                                                                                                      │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_continuous_gamma_exceeds_zone_widening — At 80% utilization with β=7.0, GLFT spread > old Red zone spread                                                                                                         │
│ - test_continuous_gamma_monotonic — γ(q) strictly increasing for q ∈ [0, q_max]                                                                                                                                          │
│ - test_kill_guard_independent — At >100%, accumulating side still cleared regardless of gamma                                                                                                                            │
│ - test_no_discontinuity_at_old_boundaries — Smooth spread transition at 60% and 80%                                                                                                                                      │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 3: Directional Flow Model (κ_buy / κ_sell)                                                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ Goal: Use existing TradeFlowTracker's buy/sell EWMA to asymmetrize kappa before fills confirm direction.                                                                                                                 │
│                                                                                                                                                                                                                          │
│ Key Insight: Infrastructure Already Exists                                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ - MarketParams.kappa_bid and .kappa_ask already exist (market_params.rs:116,121)                                                                                                                                         │
│ - TradeFlowTracker already tracks buy/sell at 4 horizons (trade_flow_tracker.rs:41-49)                                                                                                                                   │
│ - glft.rs:969-971 already uses kappa_bid and kappa_ask separately                                                                                                                                                        │
│ - HawkesOrderFlowEstimator already has lambda_buy() and lambda_sell() (hawkes.rs:207-213)                                                                                                                                │
│ - Missing: flow tracker's imbalance doesn't feed into kappa_bid/kappa_ask                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/estimator/trade_flow_tracker.rs — Add method                                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ /// Flow-based directional kappa multipliers.                                                                                                                                                                            │
│ /// Buy pressure → κ_ask UP (asks fill faster), κ_bid DOWN (bids fill slower).                                                                                                                                           │
│ /// Returns (bid_mult, ask_mult) in [0.5, 2.0].                                                                                                                                                                          │
│ pub fn directional_kappa_multipliers(&self, horizon_s: f64) -> (f64, f64) {                                                                                                                                              │
│     let imb = self.imbalance_at_horizon(horizon_s);                                                                                                                                                                      │
│     let sensitivity = 0.5; // configurable                                                                                                                                                                               │
│     let ask_mult = (1.0 + sensitivity * imb).clamp(0.5, 2.0);                                                                                                                                                            │
│     let bid_mult = (1.0 - sensitivity * imb).clamp(0.5, 2.0);                                                                                                                                                            │
│     (bid_mult, ask_mult)                                                                                                                                                                                                 │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Also wire flow_imbalance as a drift observation:                                                                                                                                                                         │
│ /// Flow imbalance as a drift observation (z, R) pair.                                                                                                                                                                   │
│ pub fn drift_observation(&self, horizon_s: f64, kappa_total: f64) -> (f64, f64) {                                                                                                                                        │
│     let imb = self.imbalance_at_horizon(horizon_s);                                                                                                                                                                      │
│     let scale_factor = 0.5; // configurable                                                                                                                                                                              │
│     let z = -imb * scale_factor;                                                                                                                                                                                         │
│     let sigma_flow = 2.0;                                                                                                                                                                                                │
│     let r = sigma_flow * sigma_flow / kappa_total.max(0.1);                                                                                                                                                              │
│     (z, r)                                                                                                                                                                                                               │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/orchestrator/quote_engine.rs:1855 — Wire flow into kappa                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ // Flow-adjusted directional kappas                                                                                                                                                                                      │
│ let (flow_bid_mult, flow_ask_mult) = self.estimator                                                                                                                                                                      │
│     .trade_flow_tracker().directional_kappa_multipliers(5.0);                                                                                                                                                            │
│ kappa_bid: estimator.kappa_bid() * flow_bid_mult,                                                                                                                                                                        │
│ kappa_ask: estimator.kappa_ask() * flow_ask_mult,                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_flow_neutral_gives_unit_multipliers — Balanced flow → (1.0, 1.0)                                                                                                                                                  │
│ - test_sell_pressure_lowers_kappa_bid — Sell-heavy flow → bid_mult < 1.0 → wider bid spread                                                                                                                              │
│ - test_multipliers_bounded — Always in [0.5, 2.0]                                                                                                                                                                        │
│ - test_flow_drift_observation_sign — Sell pressure produces negative z (bearish)                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 4: Per-Level E[PnL] Filter (Replace Binary Quote Gate)                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ Goal: Replace binary QuoteDecision (NoQuote/OnlyBids/OnlyAsks) with continuous per-level expected PnL. Levels with E[PnL] ≤ 0 get dropped naturally.                                                                     │
│                                                                                                                                                                                                                          │
│ The Formula                                                                                                                                                                                                              │
│                                                                                                                                                                                                                          │
│ E[PnL](δ, side) = λ(δ) × [δ - AS(δ) - fee - carry] + drift_contribution - inventory_penalty                                                                                                                              │
│                                                                                                                                                                                                                          │
│ λ(δ)               = κ_side × exp(-κ_side × δ)          // fill intensity at depth                                                                                                                                       │
│ drift_contribution  = ±μ̂ × τ / 2                         // +for reducing, -for accumulating (see note)                                                                                                                 │
│ inventory_penalty   = γ(q) × |q/q_max| × σ² × τ × 10000 // on accumulating side                                                                                                                                          │
│                     = -0.5 × same magnitude               // bonus on reducing side                                                                                                                                      │
│ carry               = f̂ × τ_holding                       // funding carry cost (Phase 6 adds this)                                                                                                                     │
│                                                                                                                                                                                                                          │
│ Note on drift_contribution /2: The full drift over holding time τ is μ̂ × τ. We attribute half to each side because the GLFT already applies ±μ̂×τ/2 asymmetrically in half_spread_with_drift() — bid spread narrows by  │
│ μ̂×τ/2, ask spread widens by μ̂×τ/2. The E[PnL] computation mirrors this: the drift benefit (or cost) per side is half the total drift over the horizon. This is consistent with the reservation price shift r = mid +   │
│ μ̂×τ/(2γσ²), which shifts the center by half the full drift adjustment.                                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ When E[PnL] ≤ 0 → optimal size at that level is zero. This naturally produces one-sided quoting without a binary gate.                                                                                                   │
│                                                                                                                                                                                                                          │
│ Reservation Price Alignment                                                                                                                                                                                              │
│                                                                                                                                                                                                                          │
│ The RFC defines r(t,q) = mid + drift_shift - inv_penalty - fund_carry. The current GLFT decomposes this equivalently:                                                                                                    │
│ - drift_shift: Applied as ±μ̂×T/2 in half_spread_with_drift() (glft.rs:590-611), which shifts the effective center                                                                                                       │
│ - inv_penalty: Applied as inventory skew = γ×σ²×q×T in the skew layer (glft.rs:1333-1352)                                                                                                                                │
│ - fund_carry: Applied as funding_skew in glft.rs:1382-1396                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ The E[PnL] filter operates on the already-computed depths from GLFT, so it doesn't need an explicit reservation price variable. The depths already encode drift and inventory effects. Carry cost enters E[PnL] as an    │
│ additional per-fill cost term. If the computed depths ever diverge from the RFC's intent, we can extract an explicit reservation_price intermediate — but for now the math is equivalent.                                │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/strategy/glft.rs — Add method                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ pub fn expected_pnl_bps(                                                                                                                                                                                                 │
│     &self, depth_bps: f64, is_bid: bool,                                                                                                                                                                                 │
│     gamma: f64, kappa_side: f64, sigma: f64, time_horizon: f64,                                                                                                                                                          │
│     drift_rate: f64, position: f64, max_position: f64,                                                                                                                                                                   │
│     as_cost_bps: f64, fee_bps: f64, carry_cost_bps: f64,                                                                                                                                                                 │
│ ) -> f64 { ... }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ Note: carry_cost_bps defaults to 0.0 until Phase 6 wires it.                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/strategy/ladder_strat.rs — Apply E[PnL] filter                                                                                                                                                       │
│                                                                                                                                                                                                                          │
│ After depths computed, before zone system (which is already removed in Phase 2):                                                                                                                                         │
│ if market_params.use_epnl_filter {                                                                                                                                                                                       │
│     dynamic_depths.bid.retain(|&d| self.expected_pnl_bps(d, true, ...) > 0.0);                                                                                                                                           │
│     dynamic_depths.ask.retain(|&d| self.expected_pnl_bps(d, false, ...) > 0.0);                                                                                                                                          │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ C. src/market_maker/orchestrator/quote_engine.rs:2467-2511 — Bypass quote gate                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ Phase 4a (dual-run): Keep gate for logging, don't act on it when use_epnl_filter=true.                                                                                                                                   │
│ Phase 4b: Remove gate decision block entirely.                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ D. src/market_maker/strategy/ladder_strat.rs:1643 — Remove toxicity size mult                                                                                                                                            │
│                                                                                                                                                                                                                          │
│ Subsumed by E[PnL]: high toxicity → high AS cost → E[PnL] < 0 at touch → levels dropped.                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ E. src/market_maker/strategy/market_params.rs — Add field                                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ #[serde(default)]                                                                                                                                                                                                        │
│ pub use_epnl_filter: bool,  // false during dual-run, true after validation                                                                                                                                              │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_epnl_positive_at_touch_zero_inventory — E[PnL] > 0 at GLFT depth with no position                                                                                                                                 │
│ - test_epnl_negative_accumulating_high_inventory — At 80% long, bid E[PnL] < 0                                                                                                                                           │
│ - test_epnl_positive_reducing_high_inventory — At 80% long, ask E[PnL] > 0 (reducing bonus)                                                                                                                              │
│ - test_epnl_all_negative_cascade — With 5× sigma, all E[PnL] < 0 (matches NoQuote behavior)                                                                                                                              │
│ - test_epnl_drift_skews_correctly — Negative drift makes bid E[PnL] < ask E[PnL]                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 5: Online Parameter Estimation + Cleanup                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ Goal: Wire Kalman parameters (θ, σ_μ) to online adaptation. Clean up dead code.                                                                                                                                          │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/strategy/drift_estimator.rs — Add parameter adaptation                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ update_parameters(realized_drift_bps): EWMA of prediction errors adjusts θ (0.99×/1.01× per fill) and process_noise (1.05×/0.95×). Bounded: θ ∈ [0.01, 1.0], noise ∈ [0.1, 10.0].                                        │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/orchestrator/handlers.rs — Wire fill feedback                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ After markout window completes, feed realized drift to drift_estimator.update_parameters().                                                                                                                              │
│                                                                                                                                                                                                                          │
│ C. Dead code removal (after all phases validated)                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ - quote_gate.rs:1822 — Remove dead signal_weight in decide_calibrated                                                                                                                                                    │
│ - ladder_strat.rs:1022-1054 — Zone classification (already removed Phase 2)                                                                                                                                              │
│ - ladder_strat.rs:1278-1305 — Zone widening (already removed Phase 2)                                                                                                                                                    │
│ - ladder_strat.rs:1643 — pre_fill_size_mult (already removed Phase 4)                                                                                                                                                    │
│ - quote_engine.rs:644 — smoothed_drift logging                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_theta_adapts_on_undershoot — Large prediction error increases θ                                                                                                                                                   │
│ - test_parameters_bounded — θ ∈ [0.01, 1.0], σ_μ ∈ [0.1, 10.0]                                                                                                                                                           │
│ - test_cold_start_convergence — Parameters stabilize within 60s of fills                                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 6: Funding Integration (Component 6)                                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ Goal: Add funding carry cost to reservation price and E[PnL]. Add funding rate as a drift estimator observation source.                                                                                                  │
│                                                                                                                                                                                                                          │
│ Key Insight: Infrastructure 80% Complete                                                                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ FundingRateEstimator at process_models/funding.rs already has EWMA forecasting (predicted_rate()), mean-reversion (drift_adjustment()), basis_velocity(), funding_cost(), and premium tracking. It lives on              │
│ Tier2Components.funding and is accessible from the quote engine.                                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ Critical gap: No data feed. Message::UserFundings hits wildcard _ in handlers.rs and is dropped. The estimator never warms up, so all funding signals are gated off.                                                     │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/orchestrator/handlers.rs — Wire funding data feed                                                                                                                                                    │
│                                                                                                                                                                                                                          │
│ Add handler for Message::UserFundings:                                                                                                                                                                                   │
│ Message::UserFundings(fundings) => {                                                                                                                                                                                     │
│     for f in &fundings.data {                                                                                                                                                                                            │
│         let rate = f.funding_rate.parse::<f64>().unwrap_or(0.0);                                                                                                                                                         │
│         self.tier2.funding.record_funding(rate, f.time as u64);                                                                                                                                                          │
│     }                                                                                                                                                                                                                    │
│     Ok(())                                                                                                                                                                                                               │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Also wire AllMids-derived mark/index premium if available:                                                                                                                                                               │
│ // In on_all_mids handler, if mark and index prices available:                                                                                                                                                           │
│ self.tier2.funding.update_from_prices(mark_price, index_price);                                                                                                                                                          │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/strategy/glft.rs — Add carry cost to E[PnL]                                                                                                                                                          │
│                                                                                                                                                                                                                          │
│ Update expected_pnl_bps() from Phase 4 to include carry_cost_bps:                                                                                                                                                        │
│ // Carry cost: positive when we're on the paying side                                                                                                                                                                    │
│ let carry_cost = if (is_bid && funding_rate > 0.0) || (!is_bid && funding_rate < 0.0) {                                                                                                                                  │
│     funding_rate.abs() * tau_holding * 10_000.0  // convert to bps                                                                                                                                                       │
│ } else {                                                                                                                                                                                                                 │
│     -0.5 * funding_rate.abs() * tau_holding * 10_000.0  // receiving side bonus                                                                                                                                          │
│ };                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                          │
│ C. src/market_maker/strategy/drift_estimator.rs — Add funding observation                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ /// Extreme funding rates as bearish/bullish drift signal.                                                                                                                                                               │
│ /// High positive funding → expect downward pressure (longs capitulate).                                                                                                                                                 │
│ /// No explicit threshold — at low |funding_zscore|, R is large so Kalman gain                                                                                                                                           │
│ /// is small and the update is negligible. The math does the gating.                                                                                                                                                     │
│ pub fn update_funding(&mut self, funding_zscore: f64, scale_factor: f64) {                                                                                                                                               │
│     let z = -funding_zscore.signum() * funding_zscore.abs() * scale_factor;                                                                                                                                              │
│     let sigma_funding = 2.0;                                                                                                                                                                                             │
│     // R inversely proportional to |zscore|: extreme funding = higher confidence.                                                                                                                                        │
│     // At zscore=0.3: R = 4.0/0.3 = 13.3, Kalman gain ≈ P/(P+13.3) ≈ 0.65 — small update.                                                                                                                                │
│     // At zscore=3.0: R = 4.0/3.0 = 1.3, Kalman gain ≈ P/(P+1.3) ≈ 0.95 — large update.                                                                                                                                  │
│     let r = sigma_funding * sigma_funding / funding_zscore.abs().max(0.1);                                                                                                                                               │
│     self.update_single_observation(z, r);                                                                                                                                                                                │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ D. src/market_maker/orchestrator/quote_engine.rs — Wire funding into drift + E[PnL]                                                                                                                                      │
│                                                                                                                                                                                                                          │
│ In the quote cycle, after funding estimator update:                                                                                                                                                                      │
│ // Funding as drift observation (cold tier: every 5-10 cycles)                                                                                                                                                           │
│ let funding_rate = self.tier2.funding.current_rate();                                                                                                                                                                    │
│ let f_mean = self.tier2.funding.ewma_rate();                                                                                                                                                                             │
│ let f_std = self.tier2.funding.rate_std().max(1e-6);                                                                                                                                                                     │
│ let funding_zscore = (funding_rate - f_mean) / f_std;                                                                                                                                                                    │
│ self.drift_estimator.update_funding(funding_zscore, 0.05);                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ // Funding carry cost for E[PnL]                                                                                                                                                                                         │
│ market_params.funding_carry_bps = funding_rate * tau_holding * 10_000.0;                                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ E. src/market_maker/strategy/market_params.rs — Add field                                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ #[serde(default)]                                                                                                                                                                                                        │
│ pub funding_carry_bps: f64,  // Expected carry cost in bps for E[PnL]                                                                                                                                                    │
│                                                                                                                                                                                                                          │
│ F. src/market_maker/process_models/funding.rs — Add rate_std() method                                                                                                                                                    │
│                                                                                                                                                                                                                          │
│ /// Rolling standard deviation of funding rate observations.                                                                                                                                                             │
│ pub fn rate_std(&self) -> f64 {                                                                                                                                                                                          │
│     if self.rate_history.len() < 3 { return 0.001; }                                                                                                                                                                     │
│     let mean = self.ewma_rate;                                                                                                                                                                                           │
│     let variance = self.rate_history.iter()                                                                                                                                                                              │
│         .map(|obs| (obs.rate - mean).powi(2))                                                                                                                                                                            │
│         .sum::<f64>() / self.rate_history.len() as f64;                                                                                                                                                                  │
│     variance.sqrt()                                                                                                                                                                                                      │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_funding_observation_extreme_bearish — funding_zscore=+3.0 produces negative drift shift                                                                                                                           │
│ - test_carry_cost_positive_when_paying — Long position + positive funding = positive carry cost                                                                                                                          │
│ - test_carry_cost_negative_when_receiving — Short position + positive funding = negative carry cost (bonus)                                                                                                              │
│ - test_funding_warmup_blocks_signal — Before 3 observations, funding doesn't feed drift                                                                                                                                  │
│ - test_epnl_with_carry_narrows_profitability — E[PnL] with carry cost < E[PnL] without when paying                                                                                                                       │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 7: Feature Pipeline — Book Microstructure (Hot Tier)                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ Goal: Add BIM at multiple depths, ΔBIM, book pressure gradient, and sweep detection as Kalman drift observations. These are hot-tier features (< 1ms, every cycle).                                                      │
│                                                                                                                                                                                                                          │
│ Critical Design Decision: Preventing P Collapse                                                                                                                                                                          │
│                                                                                                                                                                                                                          │
│ With 4+ observations per cycle (BIM, ΔBIM, BPG, sweep) at ~5-6s cycle time, the posterior variance P will collapse rapidly — each Kalman update shrinks P, making the filter overconfident and slow to reverse           │
│ direction. This is fine in unit tests but dangerous live when the filter locks onto a trend and ignores a reversal.                                                                                                      │
│                                                                                                                                                                                                                          │
│ Solution: Composite observation + P_min floor.                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ 1. Composite observation: Batch all hot-tier features into a single weighted observation per cycle instead of 4 separate updates:                                                                                        │
│ // Combine hot-tier signals into one (z_composite, R_composite)                                                                                                                                                          │
│ let signals = [(z_bim, r_bim, w_bim), (z_dbim, r_dbim, w_dbim), (z_bpg, r_bpg, w_bpg), (z_sweep, r_sweep, w_sweep)];                                                                                                     │
│ let (z_composite, r_composite) = weighted_composite_observation(&signals);                                                                                                                                               │
│ self.drift_estimator.update_single_observation(z_composite, r_composite);                                                                                                                                                │
│ 1. This is 1 update per cycle instead of 4, so P shrinks at 1/4 the rate. The composite preserves information (agreeing signals → low R, disagreeing → high R) without over-updating P.                                  │
│ 2. P_min floor: Add minimum posterior variance to prevent lock-in:                                                                                                                                                       │
│ const P_MIN: f64 = 2.0; // Never more confident than √2 ≈ 1.4 bps uncertainty                                                                                                                                            │
│ // After update: P = (1 - K) * P_prior                                                                                                                                                                                   │
│ self.state_variance = self.state_variance.max(P_MIN);                                                                                                                                                                    │
│ 2. At P=2.0, the filter can still track ~5+ bps drift shifts but retains enough uncertainty to reverse within a few cycles when signals change direction. P_min corresponds to ~8% of the stationary variance (P₀=25),   │
│ meaning the filter is never more than ~92% confident.                                                                                                                                                                    │
│ 3. Warm/cold tiers are naturally limited: Warm features update every 2-3 cycles, cold every 5-10. These contribute far fewer updates and don't need the composite treatment.                                             │
│                                                                                                                                                                                                                          │
│ Key Insight: Partial Infrastructure Exists                                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ - ParameterEstimator.book_imbalance() already computes BIM at a single depth (parameter_estimator.rs:681)                                                                                                                │
│ - BookDynamicsTracker already has thinning_direction() and depth change rate EWMAs (book_dynamics.rs:24-51)                                                                                                              │
│ - MicrostructureExtractor already has book_velocity_zscore (microstructure_features.rs:178)                                                                                                                              │
│ - L2 book updates flow through messages/l2_book.rs:88 → estimator.on_l2_book()                                                                                                                                           │
│ - Missing: BIM at multiple depths, ΔBIM as derivative, BPG = BIM(10)-BIM(50), sweep detection                                                                                                                            │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/estimator/parameter_estimator.rs — Multi-depth BIM                                                                                                                                                   │
│                                                                                                                                                                                                                          │
│ Add alongside existing book_imbalance():                                                                                                                                                                                 │
│ /// Book imbalance at specific depth (bps from mid).                                                                                                                                                                     │
│ pub fn book_imbalance_at_depth(&self, depth_bps: f64) -> f64 { ... }                                                                                                                                                     │
│                                                                                                                                                                                                                          │
│ /// Book imbalance at 3 depths: 10, 25, 50 bps.                                                                                                                                                                          │
│ pub fn book_imbalance_multi(&self) -> (f64, f64, f64) {                                                                                                                                                                  │
│     (self.book_imbalance_at_depth(10.0),                                                                                                                                                                                 │
│      self.book_imbalance_at_depth(25.0),                                                                                                                                                                                 │
│      self.book_imbalance_at_depth(50.0))                                                                                                                                                                                 │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Store L2 book snapshot for depth-based queries (currently only stores aggregate imbalance).                                                                                                                              │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/adverse_selection/book_dynamics.rs — Add ΔBIM and BPG                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ /// Rate of change of book imbalance (ΔBIM).                                                                                                                                                                             │
│ /// Rapidly deteriorating bid side (ΔBIM << 0) precedes price drops.                                                                                                                                                     │
│ pub fn book_imbalance_delta(&self) -> f64 {                                                                                                                                                                              │
│     // Use existing bid_change_rate_ema / ask_change_rate_ema                                                                                                                                                            │
│     self.bid_change_rate_ema - self.ask_change_rate_ema                                                                                                                                                                  │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ /// Book Pressure Gradient: BIM(shallow) - BIM(deep).                                                                                                                                                                    │
│ /// BPG > 0 → support concentrated near touch (fragile).                                                                                                                                                                 │
│ /// BPG < 0 → support distributed deep (resilient).                                                                                                                                                                      │
│ pub fn book_pressure_gradient(&self, bim_shallow: f64, bim_deep: f64) -> f64 {                                                                                                                                           │
│     bim_shallow - bim_deep                                                                                                                                                                                               │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ C. src/market_maker/adverse_selection/microstructure_features.rs — Add sweep detection                                                                                                                                   │
│                                                                                                                                                                                                                          │
│ /// Sweep detector: identifies multi-level fills within a short window.                                                                                                                                                  │
│ pub struct SweepDetector {                                                                                                                                                                                               │
│     recent_fills: VecDeque<SweepFill>,                                                                                                                                                                                   │
│     tau_sweep_ms: u64,  // detection window, default 3000ms                                                                                                                                                              │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ struct SweepFill {                                                                                                                                                                                                       │
│     timestamp_ms: u64,                                                                                                                                                                                                   │
│     is_buy: bool,                                                                                                                                                                                                        │
│     size: f64,                                                                                                                                                                                                           │
│     levels_crossed: u32,                                                                                                                                                                                                 │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ impl SweepDetector {                                                                                                                                                                                                     │
│     pub fn record_fill(&mut self, is_buy: bool, size: f64, levels_crossed: u32, now_ms: u64);                                                                                                                            │
│     /// Returns (bid_sweep_score, ask_sweep_score) for the current window.                                                                                                                                               │
│     pub fn sweep_scores(&self, now_ms: u64) -> (f64, f64);                                                                                                                                                               │
│     /// As a drift observation: z = -bid_sweep + ask_sweep, R based on total score.                                                                                                                                      │
│     pub fn drift_observation(&self, now_ms: u64) -> Option<(f64, f64)>;                                                                                                                                                  │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ D. src/market_maker/orchestrator/quote_engine.rs — Wire hot-tier features into Kalman                                                                                                                                    │
│                                                                                                                                                                                                                          │
│ In the quote cycle, after L2 book update and existing signal collection. Uses composite observation to prevent P collapse (see design decision above):                                                                   │
│ // Hot-tier book features → single composite drift observation                                                                                                                                                           │
│ let (bim10, _bim25, bim50) = self.estimator.book_imbalance_multi();                                                                                                                                                      │
│ let book_depth_usd = /* from L2 book */;                                                                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ // Individual signal (z, R) pairs                                                                                                                                                                                        │
│ let alpha_bim = 0.3;                                                                                                                                                                                                     │
│ let r_bim = 1.5_f64.powi(2) / book_depth_usd.max(100.0);                                                                                                                                                                 │
│ let z_bim = bim10 * alpha_bim;                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ let dbim = self.tier1.book_dynamics.book_imbalance_delta();                                                                                                                                                              │
│ let z_dbim = dbim * 0.2;                                                                                                                                                                                                 │
│ let r_dbim = 2.0_f64.powi(2);                                                                                                                                                                                            │
│                                                                                                                                                                                                                          │
│ let bpg = self.tier1.book_dynamics.book_pressure_gradient(bim10, bim50);                                                                                                                                                 │
│ let z_bpg = -bpg * self.position().signum() * 0.15;                                                                                                                                                                      │
│ let r_bpg = 3.0;                                                                                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ let (z_sweep, r_sweep) = self.tier1.sweep_detector.drift_observation(now_ms)                                                                                                                                             │
│     .unwrap_or((0.0, 100.0)); // high R = no observation                                                                                                                                                                 │
│                                                                                                                                                                                                                          │
│ // Combine into single composite: precision-weighted average                                                                                                                                                             │
│ // z_composite = Σ(z_i / R_i) / Σ(1/R_i),  R_composite = 1 / Σ(1/R_i)                                                                                                                                                    │
│ let signals = [(z_bim, r_bim), (z_dbim, r_dbim), (z_bpg, r_bpg), (z_sweep, r_sweep)];                                                                                                                                    │
│ let precision_sum: f64 = signals.iter().map(|(_, r)| 1.0 / r).sum();                                                                                                                                                     │
│ let z_composite: f64 = signals.iter().map(|(z, r)| z / r).sum::<f64>() / precision_sum;                                                                                                                                  │
│ let r_composite = 1.0 / precision_sum;                                                                                                                                                                                   │
│                                                                                                                                                                                                                          │
│ // Single Kalman update per cycle — P shrinks once, not 4 times                                                                                                                                                          │
│ self.drift_estimator.update_single_observation(z_composite, r_composite);                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ E. src/market_maker/core/components.rs — Add SweepDetector to Tier1                                                                                                                                                      │
│                                                                                                                                                                                                                          │
│ pub struct Tier1Components {                                                                                                                                                                                             │
│     // ... existing                                                                                                                                                                                                      │
│     pub sweep_detector: SweepDetector,                                                                                                                                                                                   │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_bim_multi_depth_correct — BIM(10) ≠ BIM(50) when book shape varies                                                                                                                                                │
│ - test_dbim_negative_precedes_drop — Rapidly deteriorating bids produce negative ΔBIM                                                                                                                                    │
│ - test_bpg_fragile_support — Shallow support (BPG > 0) + long position → bearish observation                                                                                                                             │
│ - test_sweep_detection_multi_level — 3+ fills crossing levels within 3s → high sweep score                                                                                                                               │
│ - test_sweep_drift_observation_sign — Bid-side sweep produces negative z (bearish)                                                                                                                                       │
│ - test_hot_tier_latency — All hot-tier features compute in < 1ms                                                                                                                                                         │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase 8: Feature Pipeline — Trade Flow, Cross-Venue, Volatility (Warm/Cold Tiers)                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Goal: Add warm-tier features (Hawkes intensity, fill size distribution, basis) and cold-tier features (cross-asset lead, OI, vol term structure, kurtosis) as Kalman drift observations.                                 │
│                                                                                                                                                                                                                          │
│ Key Insight: Most Infrastructure Already Exists                                                                                                                                                                          │
│                                                                                                                                                                                                                          │
│ - Hawkes: HawkesOrderFlowEstimator already has lambda_buy(), lambda_sell(), flow_imbalance() (hawkes.rs:207-237)                                                                                                         │
│ - Cross-venue: CrossVenueAnalyzer with flow_acceleration(), combined_direction (cross_venue.rs)                                                                                                                          │
│ - Lead-lag: LagAnalyzer exists (lag_analysis.rs)                                                                                                                                                                         │
│ - VPIN: VpinEstimator with vpin(), vpin_velocity() (vpin.rs)                                                                                                                                                             │
│ - Volatility: VolatilityFilter with regime detection, sigma_clean(), sigma_effective() (volatility_filter.rs)                                                                                                            │
│ - Missing: OI tracking (not in codebase), vol term structure ratio, explicit kurtosis, fill size distribution shift                                                                                                      │
│                                                                                                                                                                                                                          │
│ Files Modified                                                                                                                                                                                                           │
│                                                                                                                                                                                                                          │
│ A. src/market_maker/process_models/hawkes.rs — Add drift observation method                                                                                                                                              │
│                                                                                                                                                                                                                          │
│ impl HawkesOrderFlowEstimator {                                                                                                                                                                                          │
│     /// Excess intensity as drift observation.                                                                                                                                                                           │
│     /// When λ_sell >> λ_base on bid side, we're in a selling burst.                                                                                                                                                     │
│     pub fn drift_observation(&self) -> Option<(f64, f64)> {                                                                                                                                                              │
│         if !self.is_warmed_up() { return None; }                                                                                                                                                                         │
│         let excess_sell = self.lambda_sell() - self.config.mu;                                                                                                                                                           │
│         let excess_buy = self.lambda_buy() - self.config.mu;                                                                                                                                                             │
│         let z = -(excess_sell - excess_buy); // net excess sell pressure → bearish                                                                                                                                       │
│         let sigma_hawkes = 1.5;                                                                                                                                                                                          │
│         let total_lambda = (self.lambda_total()).max(0.1);                                                                                                                                                               │
│         let r = sigma_hawkes * sigma_hawkes / total_lambda;                                                                                                                                                              │
│         Some((z, r))                                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                    │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ B. src/market_maker/adverse_selection/microstructure_features.rs — Add fill size distribution                                                                                                                            │
│                                                                                                                                                                                                                          │
│ /// Detects shift in fill size distribution (informed traders use different sizes).                                                                                                                                      │
│ pub struct FillSizeDistributionTracker {                                                                                                                                                                                 │
│     baseline_mean: f64,                                                                                                                                                                                                  │
│     baseline_std: f64,                                                                                                                                                                                                   │
│     recent_fills_bid: VecDeque<f64>,  // last N bid fill sizes                                                                                                                                                           │
│     recent_fills_ask: VecDeque<f64>,  // last N ask fill sizes                                                                                                                                                           │
│     ewma_alpha: f64,                                                                                                                                                                                                     │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ impl FillSizeDistributionTracker {                                                                                                                                                                                       │
│     pub fn record_fill(&mut self, is_buy: bool, size: f64);                                                                                                                                                              │
│     /// Z-score of recent bid fill size vs baseline.                                                                                                                                                                     │
│     pub fn size_zscore_bid(&self) -> f64;                                                                                                                                                                                │
│     pub fn size_zscore_ask(&self) -> f64;                                                                                                                                                                                │
│     /// As drift observation: large bid fills → bearish.                                                                                                                                                                 │
│     pub fn drift_observation(&self) -> Option<(f64, f64)>;                                                                                                                                                               │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ C. src/market_maker/estimator/mod.rs — Add vol term structure and kurtosis                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ /// Short-term vs long-term realized vol ratio.                                                                                                                                                                          │
│ /// vol_ratio >> 1 → volatility expansion → widen spreads.                                                                                                                                                               │
│ pub fn vol_term_structure_ratio(&self) -> f64 {                                                                                                                                                                          │
│     let sigma_short = self.sigma_realized_30s();                                                                                                                                                                         │
│     let sigma_long = self.sigma_realized_300s();                                                                                                                                                                         │
│     if sigma_long < 1e-10 { return 1.0; }                                                                                                                                                                                │
│     sigma_short / sigma_long                                                                                                                                                                                             │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ /// Excess kurtosis of recent returns (0 = Gaussian, >0 = fat tails).                                                                                                                                                    │
│ pub fn return_kurtosis(&self) -> f64 {                                                                                                                                                                                   │
│     // Use recent return buffer                                                                                                                                                                                          │
│     // kurt = E[(r - μ)^4] / σ^4 - 3                                                                                                                                                                                     │
│     ...                                                                                                                                                                                                                  │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ Add sigma_effective scaling based on vol_ratio:                                                                                                                                                                          │
│ /// σ_effective = σ_baseline × max(1.0, vol_ratio^ν)                                                                                                                                                                     │
│ /// ν = 0.5: sqrt-scaling (4x vol spike → 2x spread widening)                                                                                                                                                            │
│ pub fn sigma_with_term_structure(&self, nu: f64) -> f64 {                                                                                                                                                                │
│     let ratio = self.vol_term_structure_ratio();                                                                                                                                                                         │
│     self.sigma_effective() * ratio.max(1.0).powf(nu)                                                                                                                                                                     │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ D. src/market_maker/estimator/cross_venue.rs — Add drift observation methods                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ impl CrossVenueAnalyzer {                                                                                                                                                                                                │
│     /// Spot-perp basis change as drift observation.                                                                                                                                                                     │
│     pub fn basis_drift_observation(&self) -> Option<(f64, f64)> {                                                                                                                                                        │
│         let delta_basis = self.basis_delta();                                                                                                                                                                            │
│         let alpha_basis = 0.2;                                                                                                                                                                                           │
│         let z = delta_basis * alpha_basis;                                                                                                                                                                               │
│         let sigma_basis = 2.0;                                                                                                                                                                                           │
│         Some((z, sigma_basis * sigma_basis))                                                                                                                                                                             │
│     }                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                          │
│     /// Cross-asset lead signal as drift observation.                                                                                                                                                                    │
│     /// BTC moved but HYPE hasn't followed → leading indicator.                                                                                                                                                          │
│     pub fn lead_drift_observation(&self) -> Option<(f64, f64)> {                                                                                                                                                         │
│         let lead = self.lead_signal();                                                                                                                                                                                   │
│         let confidence = self.lead_lag_confidence();                                                                                                                                                                     │
│         if confidence < 0.3 { return None; }                                                                                                                                                                             │
│         let alpha_lead = 0.3;                                                                                                                                                                                            │
│         let sigma_lead = 1.5;                                                                                                                                                                                            │
│         let r = sigma_lead * sigma_lead / confidence;                                                                                                                                                                    │
│         Some((lead * alpha_lead, r))                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                    │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ E. src/market_maker/orchestrator/quote_engine.rs — Wire warm/cold tiers                                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ // Warm tier (every 2-3 cycles)                                                                                                                                                                                          │
│ if cycle_count % 2 == 0 {                                                                                                                                                                                                │
│     // Hawkes intensity                                                                                                                                                                                                  │
│     if let Some((z, r)) = self.tier2.hawkes.drift_observation() {                                                                                                                                                        │
│         self.drift_estimator.update_single_observation(z, r);                                                                                                                                                            │
│     }                                                                                                                                                                                                                    │
│     // Fill size distribution                                                                                                                                                                                            │
│     if let Some((z, r)) = self.tier1.fill_size_tracker.drift_observation() {                                                                                                                                             │
│         self.drift_estimator.update_single_observation(z, r);                                                                                                                                                            │
│     }                                                                                                                                                                                                                    │
│     // Basis                                                                                                                                                                                                             │
│     if let Some((z, r)) = self.cross_venue.basis_drift_observation() {                                                                                                                                                   │
│         self.drift_estimator.update_single_observation(z, r);                                                                                                                                                            │
│     }                                                                                                                                                                                                                    │
│     // Vol term structure → sigma                                                                                                                                                                                        │
│     let vol_ratio = self.estimator.vol_term_structure_ratio();                                                                                                                                                           │
│     sigma_effective = self.estimator.sigma_effective() * vol_ratio.max(1.0).powf(0.5);                                                                                                                                   │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ // Cold tier (every 5-10 cycles)                                                                                                                                                                                         │
│ if cycle_count % 5 == 0 {                                                                                                                                                                                                │
│     // Cross-asset lead                                                                                                                                                                                                  │
│     if let Some((z, r)) = self.cross_venue.lead_drift_observation() {                                                                                                                                                    │
│         self.drift_estimator.update_single_observation(z, r);                                                                                                                                                            │
│     }                                                                                                                                                                                                                    │
│     // Funding zscore (already wired in Phase 6)                                                                                                                                                                         │
│     // Kurtosis → adjust AS_ratio                                                                                                                                                                                        │
│     let kurt = self.estimator.return_kurtosis();                                                                                                                                                                         │
│     let kappa_tail = 0.3;                                                                                                                                                                                                │
│     market_params.as_ratio_adjustment = 1.0 + kappa_tail * kurt.max(0.0);                                                                                                                                                │
│ }                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ F. src/market_maker/strategy/market_params.rs — Add fields                                                                                                                                                               │
│                                                                                                                                                                                                                          │
│ #[serde(default)]                                                                                                                                                                                                        │
│ pub vol_term_structure_ratio: f64,  // σ_short / σ_long                                                                                                                                                                  │
│                                                                                                                                                                                                                          │
│ #[serde(default = "default_one")]                                                                                                                                                                                        │
│ pub as_ratio_adjustment: f64,  // kurtosis-based AS scaling (≥ 1.0)                                                                                                                                                      │
│                                                                                                                                                                                                                          │
│ OI Tracking (New — Not Currently in Codebase)                                                                                                                                                                            │
│                                                                                                                                                                                                                          │
│ OI is not tracked. For Phase 8, we defer OI to a follow-up since it requires a new exchange API subscription. The feature pipeline is designed to accept new observation sources without modification — OI can be added  │
│ later as:                                                                                                                                                                                                                │
│ // z_oi = ΔOI · sign(price_return) · α_oi                                                                                                                                                                                │
│ // R_oi = σ_oi²                                                                                                                                                                                                          │
│                                                                                                                                                                                                                          │
│ Verification                                                                                                                                                                                                             │
│                                                                                                                                                                                                                          │
│ - test_hawkes_excess_sell_bearish — Sell burst → negative drift observation                                                                                                                                              │
│ - test_fill_size_shift_large_bids_bearish — Unusually large bid fills → bearish                                                                                                                                          │
│ - test_basis_compression_bearish_when_long — Basis compressing → bearish                                                                                                                                                 │
│ - test_lead_signal_btc_drop — BTC drops + HYPE flat → negative lead signal                                                                                                                                               │
│ - test_vol_ratio_widens_sigma — 4x vol spike → 2x sigma (with ν=0.5)                                                                                                                                                     │
│ - test_kurtosis_scales_as_ratio — Fat tails (kurt > 0) → AS_ratio > 1.0                                                                                                                                                  │
│ - test_warm_tier_latency — All warm features < 10ms                                                                                                                                                                      │
│ - test_cold_tier_latency — All cold features < 100ms                                                                                                                                                                     │
│                                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                                      │
│ Phase Dependencies                                                                                                                                                                                                       │
│                                                                                                                                                                                                                          │
│ Phase 1 (Kalman Drift)        ←── can start immediately                                                                                                                                                                  │
│ Phase 2 (Continuous γ)         ←── independent, can parallel Phase 1                                                                                                                                                     │
│ Phase 3 (Directional κ)        ←── independent, can parallel Phase 1+2                                                                                                                                                   │
│ Phase 4 (E[PnL] Gate)          ←── requires Phases 1+2+3 complete                                                                                                                                                        │
│ Phase 5 (Online Params)         ←── requires Phase 4 validated                                                                                                                                                           │
│ Phase 6 (Funding Integration)   ←── requires Phase 4 (E[PnL] formula), can parallel Phase 5                                                                                                                              │
│ Phase 7 (Book Microstructure)   ←── requires Phase 1 (Kalman interface), can parallel 4+5+6                                                                                                                              │
│ Phase 8 (Trade Flow/Cross-Ven)  ←── requires Phase 1 (Kalman interface), can parallel 5+6+7                                                                                                                              │
│                                                                                                                                                                                                                          │
│ Parallelism: Phases 1+2+3 run in parallel. Then Phase 4. Then Phases 5+6+7+8 can run in parallel (all independent after Phase 4 provides E[PnL]).                                                                        │
│                                                                                                                                                                                                                          │
│ Feature Gates (Rollback Strategy)                                                                                                                                                                                        │
│                                                                                                                                                                                                                          │
│ ┌───────┬────────────────────────┬────────────────────┬──────────────────────────────────────────────┐                                                                                                                   │
│ │ Phase │          Gate          │      Default       │                   Rollback                   │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 1     │ use_kalman_drift: bool │ true               │ Falls back to LegacyDriftEstimator           │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 2     │ inventory_beta: f64    │ 7.0                │ Set to 3.0 (current behavior)                │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 3     │ Flow sensitivity       │ 0.5                │ Set to 0.0 (multipliers = 1.0)               │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 4     │ use_epnl_filter: bool  │ false              │ Old gate + zones active                      │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 5     │ Adaptation bounds      │ Clamped            │ Parameters frozen at defaults                │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 6     │ Funding scale_factor   │ 0.05               │ Set to 0.0 (funding doesn't feed drift)      │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 7     │ Feature α values       │ Calibrated offline │ Set all α to 0.0 (features don't feed drift) │                                                                                                                   │
│ ├───────┼────────────────────────┼────────────────────┼──────────────────────────────────────────────┤                                                                                                                   │
│ │ 8     │ Feature α values       │ Calibrated offline │ Set all α to 0.0 (features don't feed drift) │                                                                                                                   │
│ └───────┴────────────────────────┴────────────────────┴──────────────────────────────────────────────┘                                                                                                                   │
│                                                                                                                                                                                                                          │
│ Verification (End-to-End)                                                                                                                                                                                                │
│                                                                                                                                                                                                                          │
│ 1. cargo clippy -- -D warnings — clean                                                                                                                                                                                   │
│ 2. cargo test — all pass                                                                                                                                                                                                 │
│ 3. Paper trading checks:                                                                                                                                                                                                 │
│   - drift_rate_per_sec nonzero and unclamped during trends                                                                                                                                                               │
│   - drift_uncertainty_bps decreasing as observations accumulate                                                                                                                                                          │
│   - Bid depths pull back > 3 bps during bearish trends (old cap broken)                                                                                                                                                  │
│   - At 70%+ inventory: accumulating side has zero levels (E[PnL] < 0)                                                                                                                                                    │
│   - At 30% inventory: both sides quoted (continuous, no zone jump)                                                                                                                                                       │
│   - kappa_bid ≠ kappa_ask during flow imbalance                                                                                                                                                                          │
│   - Kill switch still fires at >100% utilization                                                                                                                                                                         │
│   - Funding carry cost visible in E[PnL] logs during high-funding periods                                                                                                                                                │
│   - Book features shift μ̂ before fills arrive (verify on replay)                                                                                                                                                        │
│   - Hawkes intensity observation fires during trade clusters                                                                                                                                                             │
│   - Cross-asset lead signal observable when BTC moves first