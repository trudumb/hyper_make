# End-to-End: Event to Quote with Continuous Stochastic Bayesian Inference

## 1. The Core Problem

The current system has **seven independent signal subsystems** that each detect the downtrend, but the central belief system that should unify them is broken. At 00:52:37, with position +4.87 long into a 5% selloff:

| Subsystem | What it saw | What it did |
|-----------|-------------|-------------|
| Multi-timeframe trend | short=-17bps, med=-13bps, long=-28bps, agreement=1.0 | Set `trend_conf=0.70`, `is_opposed=True` |
| Toxicity estimator | toxicity=0.68 | Set `p_informed=0.323` |
| AS feedback | alpha=0.323 | Reduced kappa from 2161→1813 |
| Position continuation | `continuation_p=0.73`, `is_opposed=True` | Logged it |
| Margin allocation | inventory_ratio=0.35 | Split margin 38.5 bid / 58.9 ask |
| Edge scatter | bias recalibration needed | Logged a warning |
| **Belief system** | **1100 observations, -10.54bps returns** | **prob_bull=0.500, prob_bear=0.500, drift=-0.00** |

The belief system is the bottleneck. It feeds `belief_drift_bps` into the reservation price, which drives the skew, which drives the asymmetry between bid and ask quotes. Because it outputs 0.00 forever, all the downstream trend information that other modules detect has **no path to the quotes**.

The trend detector knows. The toxicity estimator knows. The AS feedback knows. But the thing that actually shifts the mid — the belief system — is deaf.

---

## 2. Why the Current Belief System Is Broken

The belief system runs a Bayesian update on mid-price returns:

```
Prior:     μ ~ N(0, expected_sigma²)     where expected_sigma = 0.001 (100 bps)
Likelihood: Δp_t | μ ~ N(μ · dt, σ²_observed · dt)
Posterior:  standard conjugate normal update
```

The problem is the prior variance (σ² = 0.001² = 10⁻⁶) is enormous relative to individual return observations. A single 3-second return of -10.54 bps = -0.001054 has a signal-to-noise ratio against this prior of roughly:

```
SNR = |observation| / prior_sigma = 0.001054 / 0.001 ≈ 1.0
```

A single observation with SNR ≈ 1 barely moves the posterior. After N observations, the posterior drift estimate is:

```
μ_posterior ≈ (N · σ²_prior · x̄) / (σ²_observed + N · σ²_prior)
```

With σ_prior = 0.001 and σ_observed ≈ 0.0002 (per-tick vol), the effective N needed to get drift_confidence > 0.5 is:

```
N > σ²_observed / σ²_prior = (0.0002)² / (0.001)² = 0.04
```

So mathematically, N=1 should suffice — but the logs show drift_confidence = 0.001 at N=10 and only 0.099 at N=1100. Something is additionally clamping or decaying the confidence. The update rate is ~0.0001 per observation, meaning the system needs ~5,000 observations (~4 hours) to reach confidence 0.5.

**This is not Bayesian inference. This is a prior that refuses to update.**

Moreover, the belief system only ingests **one data source**: mid-price returns. It ignores fills, fill sides, adverse selection, order flow, toxicity, trend detection, and every other signal the system computes.

---

## 3. The Unified State: What a Stochastic Bayesian Market Maker Maintains

Instead of seven independent subsystems that don't talk to each other, the system should maintain a **single joint posterior** over the market state, continuously updated by every observable event.

### 3.1 The Hidden State Vector

At any moment, the market's unobservable true state is:

```
θ = {
    μ       : drift rate (bps/s) — the directional tendency of the true price
    σ       : instantaneous volatility
    κ       : order arrival intensity (fills per second)
    π       : probability of informed trading (toxicity)
    regime  : {trending, mean-reverting, volatile, quiet}
}
```

We never observe θ directly. We observe events that are generated by θ.

### 3.2 The Observable Events

Every event carries information about θ. The system receives these event streams:

```
Event stream              What it tells us about θ
─────────────────────────────────────────────────────────────
Mid-price tick (Δp)       μ, σ  — drift and volatility
Own fill (side, size, px) μ, π  — who's aggressing and why
Adverse selection (bps)   π, μ  — informed flow magnitude and direction
Book imbalance change     μ     — passive directional pressure
Trade print (tape)        κ, μ  — arrival intensity and aggressor side
Book depth change         κ, σ  — liquidity regime
Spread change             σ, π  — volatility and toxicity
[Cross-venue mid delta]   μ     — lead-lag directional signal
```

### 3.3 The Posterior We Maintain

The full posterior is:

```
P(θ_t | E_1, E_2, ..., E_t)
```

where E_i are all events up to time t. In practice, we factor this into tractable components:

```
P(μ_t | events)     — directional posterior (the critical missing piece)
P(σ_t | events)     — volatility posterior
P(π_t | events)     — toxicity posterior
P(regime_t | events) — regime posterior
```

Each is updated continuously as events arrive. The key insight is that **every event type updates every posterior component** with different likelihood ratios.

---

## 4. The Pipeline: Event → Posterior → Quote

### Stage 0: Event Arrival

Events arrive asynchronously from the WebSocket feed and the fill processor. Every event has a timestamp and a type.

```
┌──────────────────────────────────────────────────────────┐
│                    EVENT BUS                              │
│                                                          │
│  mid_tick(price, ts)                                     │
│  own_fill(side, size, price, AS_bps, ts)                │
│  book_update(bids[], asks[], ts)                         │
│  trade_print(side, size, price, ts)                      │
│  [cv_tick(venue, price, ts)]   ← future: cross-venue    │
│                                                          │
└──────────────────────────────────────────────────────────┘
                         │
                         ▼
```

### Stage 1: Posterior Updates (per-event, microsecond budget)

Each event fires a set of likelihood ratio updates against the posterior components. These are conjugate or closed-form — no MCMC, no sampling, no iteration.

#### 1A. Directional Posterior P(μ | events)

This is the broken piece. Currently: always 0.500/0.500. Should be:

**State model (Ornstein-Uhlenbeck with regime switching):**

```
μ_t = μ_{t-1} + θ_μ · (0 - μ_{t-1}) · dt + σ_μ · dW
```

where θ_μ is the mean-reversion speed (slow: ~0.001/s, meaning μ has a half-life of ~10 minutes).

**Update on mid-price tick:**

```
Δp observed over interval dt
Likelihood: P(Δp | μ) = N(μ · dt, σ² · dt)
Posterior update (conjugate normal):
  precision_new = precision_old + dt / σ²
  mean_new = (precision_old · mean_old + (Δp/dt) · (dt/σ²)) / precision_new
```

This is what the current system does. The problem is precision_old is enormous (prior is too diffuse) so each update barely moves the mean.

**Fix:** Set the prior precision much tighter. The prior should represent "I believe drift is probably within ±10 bps/s" not "drift could be anything within ±100 bps/s".

**Update on own fill (THE CRITICAL ADDITION):**

```
On buy fill (sellers hit our bid):
  Likelihood ratio: P(buy_fill | μ < 0) / P(buy_fill | μ = 0)

  Under no trend:    P(buy) ≈ P(sell) ≈ 0.5
  Under downtrend:   P(buy) ≈ 0.5 + f(|μ|)   where f maps drift magnitude to fill asymmetry

  Practical LR: exp(λ_fill · side_sign)
  where λ_fill = 0.35 (calibrate to: 8 consecutive buy fills ≈ 95% confidence)
  side_sign = +1 for buy fill (bearish), -1 for sell fill (bullish)

  log_odds_μ_negative += λ_fill   (for buy fill)
  log_odds_μ_negative -= λ_fill   (for sell fill)
```

**Update on adverse selection:**

```
On fill with measured AS of A bps:
  The AS magnitude tells us HOW informed the flow is
  High AS on buys = confident informed selling

  Additional LR: exp(λ_AS · side_sign · max(0, A - fee_bps) / AS_scale)
  where λ_AS = 0.15, AS_scale = 20 bps

  Example: buy fill with 18 bps AS, fee = 1.5 bps
  → extra log_odds += 0.15 * (18 - 1.5) / 20 = 0.124
```

**Update on burst detection:**

```
If 4+ fills on same side within 2 seconds:
  This is a sweep — someone is urgently taking liquidity on one side
  
  Burst LR: exp(λ_burst · (burst_count - 3) · side_sign)
  where λ_burst = 0.25

  Example: 6 buy fills in 1 second
  → extra log_odds += 0.25 * 3 = 0.75  (very strong bearish update)
```

**Temporal decay:**

```
Every Δt seconds with no new fills:
  log_odds *= exp(-θ_decay · Δt)
  where θ_decay = 0.02/s  (half-life ≈ 35 seconds)

This ensures the posterior mean-reverts to 0.5 when information stops arriving.
Not because we believe the trend stopped, but because our CONFIDENCE in the 
estimate decays without fresh evidence.
```

**Output:** `μ_posterior` (expected drift in bps/s) and `p_down = σ(log_odds)` (probability drift is negative).

#### 1B. Volatility Posterior P(σ | events)

**State model:** σ follows a log-normal random walk (stochastic vol):

```
log(σ_t) = log(σ_{t-1}) + θ_σ · (log(σ_long) - log(σ_{t-1})) · dt + ξ · dW
```

**Update on mid-price tick:**

```
Use squared returns as sufficient statistic:
  r² = (Δp)² / dt
  
Bayesian update (inverse-gamma conjugate):
  α_new = α_old + 0.5
  β_new = β_old + 0.5 · r²
  σ²_posterior = β_new / (α_new - 1)
```

**Update on fill:**

```
Fills during high-vol periods cluster in time. Fill inter-arrival time τ is informative:
  Short τ between fills → σ is likely higher (volatile markets clear more fills)
  
  σ²_adjustment = max(1.0, count_fills_last_5s / expected_fills_5s)
```

**Output:** `σ_posterior` (instantaneous vol estimate), `vol_regime` ∈ {Low, Medium, High}.

#### 1C. Toxicity Posterior P(π | events)

The probability that the current flow is informed.

**State model:** π follows a beta distribution (conjugate to Bernoulli):

```
π ~ Beta(α_informed, α_uninformed)
```

**Update on fill with AS measurement:**

```
If AS_bps > 2 × spread_bps:
  → this fill was probably informed
  α_informed += 1

If AS_bps < 0.5 × spread_bps:
  → this fill was probably uninformed (noise)
  α_uninformed += 1

Otherwise:
  → ambiguous, fractional update
  weight = (AS_bps - 0.5 * spread) / (1.5 * spread)
  α_informed += weight
  α_uninformed += (1 - weight)
```

**Temporal decay (windowed):**

```
Every 30 seconds, decay both alpha parameters toward prior:
  α_informed *= 0.95
  α_uninformed *= 0.95
  (add small prior mass to prevent collapse to 0)
```

**Output:** `π_posterior = α_informed / (α_informed + α_uninformed)`, the MAP toxicity estimate.

#### 1D. Regime Posterior P(regime | events)

**State model:** Hidden Markov Model with 4 regimes:

```
Regimes: {trending_down, trending_up, mean_reverting, volatile}
Transition matrix A (slow transitions, ~0.001 per second)
```

**Emission likelihoods per regime:**

```
trending_down:  P(Δp < 0) high, P(buy_fill) high, P(high_AS) high
trending_up:    P(Δp > 0) high, P(sell_fill) high, P(high_AS) high  
mean_reverting: P(|Δp| small) high, P(buy≈sell) high, P(low_AS) high
volatile:       P(|Δp| large) high, P(many_fills) high
```

**Update (forward algorithm, online):**

```
On each event:
  For each regime r:
    belief(r) *= P(event | regime=r)
  Normalize: belief(r) /= Σ belief(r)
  
  Predict: belief(r) = Σ_r' A(r'→r) · belief(r')
```

This is the changepoint detector replacement. The current one (cp_prob) sits at 0.020 forever because it only uses microstructure features. This version ingests fills, AS, and price.

**Output:** `P(regime=trending_down)`, `P(regime=trending_up)`, etc.

---

### Stage 2: Posterior → Reservation Price (the GLFT core)

The Guéant-Lehalle-Fernandez-Tapia framework computes the reservation price:

```
r(t, q) = s(t) - q · γ · σ² · (T - t) + μ_posterior · (T - t)
                                            ^^^^^^^^^^^^^^^^
                                            THIS TERM WAS ZERO
```

where:
- `s(t)` = current mid-price
- `q` = current inventory (signed)
- `γ` = risk aversion
- `σ` = volatility (from posterior 1B)
- `T - t` = horizon (rolling)
- `μ_posterior` = expected drift from posterior 1A

**The μ term shifts the reservation price in the direction of expected drift.** If P(down) is high, μ_posterior is negative, reservation price moves below mid, bids get further away, asks get closer. This is the mechanism that was missing — it produces asymmetric quotes from a continuous belief about drift.

**Current system:** μ_posterior = belief_drift_bps = -0.00 always. So the reservation price equals mid minus inventory skew, which was also near zero (pos_guard_skew = 0.73 bps).

**With the fix:** At 00:52:37 with P(down) = 0.98 from fill flow:

```
μ_posterior ≈ -5 bps/s (estimated from fill-side asymmetry and AS)
horizon = 30s (rolling)
drift_shift = μ_posterior · horizon = -5 · 30 = -150 bps shift (capped)

In practice, cap at max_drift_shift = 2 × spread:
  drift_shift = max(-2 · spread_bps, μ_posterior · horizon)
              = max(-14, -150)
              = -14 bps

This means:
  reservation_price = mid - 14 bps (shifted down)
  bid = reservation - half_spread = mid - 14 - 7 = mid - 21 bps
  ask = reservation + half_spread = mid - 14 + 7 = mid - 7 bps

vs current (no drift):
  bid = mid - 7 bps
  ask = mid + 7 bps
```

The bid is now 21 bps below mid (rarely filled) and the ask is 7 bps below mid (aggressively filled). This naturally reduces long inventory.

---

### Stage 3: Reservation Price → Optimal Spread

The GLFT optimal spread incorporates all posterior components:

```
δ*(q) = (1/κ) + (γ/2) · σ² · (T-t) + π_posterior · AS_scale + regime_premium

where:
  κ           = fill arrival rate (from kappa estimator)
  σ           = volatility (from posterior 1B)  
  π_posterior = toxicity (from posterior 1C) — wider spread when flow is toxic
  AS_scale    = expected AS magnitude (from realized AS history)
  regime_premium = extra spread in trending/volatile regimes (from posterior 1D)
```

**What the posterior components contribute:**

```
Base spread:                    1/κ = 1/1813 ≈ 0.055 bps    (compensation for adverse selection risk)
Inventory risk:                 γ/2 · σ² · horizon = 0.56 * 0.000234² * 30 ≈ 0.9 bps
Toxicity premium:               π · AS_scale = 0.68 * 21 ≈ 14.3 bps
Regime premium (trending down):  5 bps  (extra caution in directional regime)

Total optimal half-spread:      ≈ 20 bps per side (vs current 7 bps)
```

At 00:52:37, with toxicity at 0.68 and trending regime, the spread should have been **~3x wider** than the 7 bps it was running. The current system does incorporate some of this (AS feedback reduced kappa, producing a ~14 bps total spread), but the symmetric application means it provided no directional protection.

---

### Stage 4: Spread + Reservation Price → Asymmetric Quote Depths

This is where the posteriors produce **different bid and ask quotes**:

```
bid_depth = half_spread + directional_shift + inventory_skew + burst_premium
ask_depth = half_spread - directional_shift - inventory_skew + burst_premium

where:
  directional_shift = f(μ_posterior)  — from drift posterior
  inventory_skew    = γ · q · σ²/κ  — from GLFT
  burst_premium     = g(burst_count) — extra distance on swept side during bursts
```

**Example at 00:52:37 (position=+4.87, P(down)=0.98, just got burst of 6 buys):**

```
half_spread       = 10 bps (widened for toxicity+regime)
directional_shift = 8 bps  (strong bearish posterior)
inventory_skew    = 3 bps  (long 4.87 units)
burst_premium     = 5 bps  (6-fill burst just detected on bid side)

bid_depth = 10 + 8 + 3 + 5 = 26 bps below mid  ← far from market, hard to fill
ask_depth = 10 - 8 - 3 + 0 = -1 → floored at fee_bps = 1.5 bps above mid  ← very tight

Result:
  bid at mid - 26 bps = 28.32 - 0.074 = $28.246
  ask at mid + 1.5 bps = 28.32 + 0.004 = $28.324
```

Compare to what actually happened:

```
Current system at 00:52:37:
  touch_bid_bps = 7.02   (symmetric)
  touch_ask_bps = 7.02   (symmetric)
  bid at $28.30, ask at $28.34
  → promptly bought 4 more HYPE at $28.30 (fill #23-26 with 25 bps AS)
```

---

### Stage 5: Quote Depths → Sizing (Margin Allocation)

The current margin allocation already has the right idea (inventory-driven split: 38.5 bid / 58.9 ask), but it doesn't go far enough.

**New sizing rule:** The directional posterior directly modulates maximum size per side:

```
max_bid_size = base_size × (1 - p_down) × inventory_capacity_bid
max_ask_size = base_size × p_down × inventory_capacity_ask

At P(down) = 0.98:
  max_bid_size = base × 0.02 × capacity  ≈ essentially zero
  max_ask_size = base × 0.98 × capacity  ≈ full size on asks
```

**Reduce-only trigger:** When the posterior is extreme AND position is opposed:

```
if p_down > 0.85 and position > min_viable_size:
    bid_size = 0                    ← no new buying
    ask_size = reduce_only_size     ← aggressive selling to flatten
    mode = Maker(ask_only)

if p_down < 0.15 and position < -min_viable_size:
    ask_size = 0
    bid_size = reduce_only_size
    mode = Maker(bid_only)
```

The threshold (0.85) means we need strong evidence before going one-sided. With the likelihood ratios calibrated in Stage 1, this corresponds to roughly 5-8 consecutive same-side fills with elevated AS — exactly the pattern we observed before the position blew up.

---

### Stage 6: Sizing → Ladder Construction (Tick-Grid Allocation)

The ladder allocator distributes size across price levels using utility-weighted softmax. The posteriors affect this through:

```
For each level i at depth d_i from reservation price:

  bid_utility(i) = expected_edge(d_i) - expected_AS(d_i) - position_cost(d_i)
  ask_utility(i) = expected_edge(d_i) - expected_AS(d_i) + position_benefit(d_i)

  where:
    expected_edge(d)    = d - fee_bps                  (half-spread minus fee)
    expected_AS(d)      = π_posterior × AS_profile(d)   (toxicity-scaled AS at depth)
    position_cost(d)    = γ × |q + Δq| × σ² / κ       (marginal inventory risk of adding)
    position_benefit(d) = γ × |q - Δq| × σ² / κ       (inventory risk reduction from reducing)
```

**The key change:** `position_cost` and `position_benefit` now use the *directional* posterior, not just the symmetric inventory penalty:

```
position_cost_directional(d) = γ × |q + Δq| × σ² / κ × (1 + |μ_posterior| × horizon / σ)

If μ_posterior < 0 and we're buying (increasing long):
  → position_cost inflated by factor of (1 + drift_penalty)
  → softmax allocates less to bid levels

If μ_posterior < 0 and we're selling (decreasing long):
  → position_benefit inflated by same factor
  → softmax allocates more to ask levels, especially near touch
```

---

### Stage 7: Ladder → Reconciler → Executor

The reconciler diffs desired orders vs resting orders and emits cancel/modify/place actions. No Bayesian logic here — this is pure order management.

However, one important addition: **emergency cancel pathway.**

```
On burst detection (4+ same-side fills in 2s):
  Bypass the normal quote cycle
  Immediately cancel all resting orders on the swept side
  Do not wait for the next 3-second quote cycle

  This requires an interrupt-driven path from fill processor → executor
  that doesn't go through the full quote pipeline
```

In the current system, fills arrive, are processed, but quotes only update on the next cycle (every ~3 seconds). During a burst, 6 fills happen in <1 second — the entire ladder gets swept before the next cycle even starts.

---

## 5. How It All Connects: One Quote Cycle, Annotated

```
EVENT: buy fill at $28.37, AS=18.4 bps, position now +4.13

 ┌─────────────────────────────────────────────────────────────────┐
 │ STAGE 1: POSTERIOR UPDATES                                      │
 │                                                                 │
 │ 1A. Directional:                                                │
 │   log_odds += 0.35 (buy fill)                                   │
 │   log_odds += 0.15 * (18.4 - 1.5) / 20 = 0.127 (high AS)     │
 │   log_odds += 0.25 * (6 - 3) = 0.75 (burst of 6)             │
 │   p_down: 0.91 → 0.98                                          │
 │   μ_posterior: -3.2 → -5.8 bps/s                               │
 │                                                                 │
 │ 1B. Volatility:                                                 │
 │   σ_posterior: 0.023% → 0.025% (slight increase from activity) │
 │                                                                 │
 │ 1C. Toxicity:                                                   │
 │   α_informed += 0.85 (AS = 18.4 >> 2 × 7 = 14)               │
 │   π_posterior: 0.62 → 0.68                                      │
 │                                                                 │
 │ 1D. Regime:                                                     │
 │   P(trending_down): 0.85 → 0.92                                │
 │   P(mean_reverting): 0.10 → 0.05                               │
 └─────────────────┬───────────────────────────────────────────────┘
                   │
                   ▼
 ┌─────────────────────────────────────────────────────────────────┐
 │ STAGE 2: RESERVATION PRICE                                      │
 │                                                                 │
 │ mid = $28.37                                                    │
 │ inventory_term = -q · γ · σ² · T = -4.13 · 0.56 · 5.5e-8 · 30│
 │               = -0.38 bps                                       │
 │ drift_term = μ_posterior · T = -5.8 · 30 = -174 bps            │
 │            → capped at -2 × spread = -14 bps                   │
 │                                                                 │
 │ reservation = $28.37 - 0.001 - 0.040 = $28.329                 │
 │ (shifted ~4 cents below mid)                                    │
 └─────────────────┬───────────────────────────────────────────────┘
                   │
                   ▼
 ┌─────────────────────────────────────────────────────────────────┐
 │ STAGE 3: OPTIMAL SPREAD                                         │
 │                                                                 │
 │ base_half_spread = 1/κ + γ/2 · σ² · T = 0.06 + 0.9 = 1.0 bps │
 │ toxicity_premium = 0.68 × 21 = 14.3 bps                        │
 │ regime_premium = 5.0 bps (trending)                             │
 │ total_half_spread = 20.3 bps                                    │
 │                                                                 │
 │ But this is the SYMMETRIC optimal spread around reservation.    │
 │ The asymmetry comes from the reservation price shift in Stage 2.│
 └─────────────────┬───────────────────────────────────────────────┘
                   │
                   ▼
 ┌─────────────────────────────────────────────────────────────────┐
 │ STAGE 4: ASYMMETRIC DEPTHS                                      │
 │                                                                 │
 │ bid_depth from mid = reservation_shift + half_spread            │
 │                    = 14 + 20.3 = 34.3 bps                      │
 │                    → bid at $28.37 - $0.097 = $28.273           │
 │                                                                 │
 │ ask_depth from mid = half_spread - reservation_shift            │
 │                    = 20.3 - 14 = 6.3 bps                       │
 │                    → ask at $28.37 + $0.018 = $28.388           │
 │                                                                 │
 │ (vs current: symmetric at 7 bps both sides)                    │
 └─────────────────┬───────────────────────────────────────────────┘
                   │
                   ▼
 ┌─────────────────────────────────────────────────────────────────┐
 │ STAGE 5: SIZING                                                 │
 │                                                                 │
 │ p_down = 0.98, position = +4.13                                 │
 │                                                                 │
 │ Since p_down > 0.85 and position > 0:                           │
 │   → REDUCE-ONLY MODE (ask_only)                                 │
 │   bid_size = 0 (no new buying)                                  │
 │   ask_size = min(position, max_reduce_size) = 4.13              │
 │                                                                 │
 │ Without reduce-only (0.7 < p_down < 0.85):                     │
 │   bid_size = base × (1 - 0.98) = base × 0.02 ≈ 0.08           │
 │   ask_size = base × 0.98 = base × 0.98 ≈ 3.92                 │
 └─────────────────┬───────────────────────────────────────────────┘
                   │
                   ▼
 ┌─────────────────────────────────────────────────────────────────┐
 │ STAGE 6: LADDER                                                 │
 │                                                                 │
 │ Bids: none (reduce-only)                                        │
 │                                                                 │
 │ Asks:                                                           │
 │   Level 1: $28.388 (6.3 bps)  size=1.50  ← aggressive touch   │
 │   Level 2: $28.394 (8.4 bps)  size=0.80                        │
 │   Level 3: $28.400 (10.5 bps) size=0.60                        │
 │   Level 4: $28.406 (12.7 bps) size=0.50                        │
 │   Level 5: $28.412 (14.8 bps) size=0.40                        │
 │   Level 6: $28.418 (16.9 bps) size=0.33                        │
 │   Total ask size: 4.13 (full position available to sell)        │
 └─────────────────┬───────────────────────────────────────────────┘
                   │
                   ▼
 ┌─────────────────────────────────────────────────────────────────┐
 │ STAGE 7: RECONCILE + EXECUTE                                    │
 │                                                                 │
 │ Cancel: all 8 resting bids                                      │
 │ Cancel: all 12 resting asks (wrong prices)                      │
 │ Place:  6 new asks at computed levels                           │
 │                                                                 │
 │ Net: went from symmetric 8-bid/12-ask to 0-bid/6-ask           │
 │ The system is now actively reducing inventory                    │
 └─────────────────────────────────────────────────────────────────┘
```

---

## 6. Continuous Update vs Cycle-Based

The current system runs on a ~3 second quote cycle. Posterior updates should happen on **every event**, not just at cycle boundaries.

```
Timeline:
  t=0.0s   fill arrives → update posteriors immediately
  t=0.3s   fill arrives → update posteriors immediately  
  t=0.5s   fill arrives → update posteriors immediately
  t=0.7s   fill arrives → update posteriors, burst detected → EMERGENCY CANCEL
  t=0.8s   fill arrives → posteriors already extreme, no resting bids to fill
  t=3.0s   quote cycle → read current posteriors, compute quotes, reconcile
```

The posterior is a **continuous-time object** that gets updated asynchronously. The quote cycle reads a snapshot of it. The emergency cancel path is the only thing that acts between cycles — it's a circuit breaker, not a quoting decision.

This means the posterior update code must be fast — O(1) per event, no allocations, no locks on the hot path. The conjugate/closed-form updates described in Stage 1 satisfy this.

---

## 7. What Changes in the Code

### Module: `belief_system` → Replace entirely

**Current:** Ingests mid-price returns only. Prior σ=0.001 never updates. Output always 0.500/0.500.

**New:** Ingests mid-price returns, fill events, AS measurements, burst counts. Maintains log-odds for directional posterior with calibrated likelihood ratios. Output is a continuously-updating `(μ_posterior, p_down, confidence)` tuple.

### Module: `quote_engine` → Wire posterior into reservation price

**Current:** `belief_drift_bps = -0.00` hardcoded by broken belief system. Skew comes only from `pos_guard_skew` (0.73 bps).

**New:** `reservation_shift = μ_posterior × horizon`, capped at ±2×spread. This is the primary driver of quote asymmetry.

### Module: `ladder_strat` → Asymmetric depths from reservation shift

**Current:** `touch_bid_bps = touch_ask_bps = 7.02` (symmetric).

**New:** `touch_bid_bps = half_spread + reservation_shift`, `touch_ask_bps = half_spread - reservation_shift`. These will be very different when the posterior is confident.

### Module: `ladder_strat` → Sizing from posterior

**Current:** Margin allocation gives slight asymmetry (38.5/58.9 split) but both sides still get substantial size.

**New:** `bid_total_size *= (1 - p_down)`, `ask_total_size *= p_down`. At P(down)=0.98, bids get 2% of normal size.

### Module: `orchestrator` → Reduce-only from posterior

**Current:** `reduce_only = false` always (gated on cross-venue signal which doesn't exist).

**New:** `reduce_only = (p_down > 0.85 and position > 0) or (p_down < 0.15 and position < 0)`. Independent of cross-venue.

### Module: `fill_processor` → Emergency cancel on burst

**Current:** Fills update the kappa estimator and AS tracker. No immediate quoting action.

**New:** On burst detection (4+ same-side in 2s), immediately cancel all orders on the swept side via a direct path to the executor. Don't wait for the next quote cycle.

### Module: `changepoint_detector` → Replace with regime HMM

**Current:** cp_prob = 0.020 always (ThinDex regime config, microstructure features only).

**New:** Forward-algorithm HMM that ingests fills, AS, and price alongside microstructure. P(trending_down) feeds into regime_premium in the spread calculation.

---

## 8. Calibration

Every likelihood ratio and threshold above has a free parameter. Calibrate on historical sessions:

| Parameter | What it controls | Calibration target |
|-----------|-----------------|-------------------|
| λ_fill = 0.35 | LR per fill side | 8 consecutive same-side fills → P(direction) > 0.95 |
| λ_AS = 0.15 | LR per bps of AS | 20 bps AS on a fill ≈ doubles the directional evidence of that fill |
| λ_burst = 0.25 | LR per extra fill in burst | 6-fill burst ≈ equivalent to 4 additional independent fills |
| θ_decay = 0.02/s | Posterior half-life without fills | ~35 seconds (one missed quote cycle shouldn't erase strong evidence) |
| p_reduce = 0.85 | Reduce-only trigger | Fires after ~6-8 consecutive bearish fills with AS > fee |
| p_resume = 0.70 | Resume two-sided trigger | ~4-5 counter-directional fills needed to exit reduce-only |
| drift_cap = 2×spread | Max reservation shift | Prevents overshooting into taking (crossing the spread) |
| skew_sensitivity = 20 | Drift-to-skew multiplier | At P(down)=0.75, skew shifts bids ~5 bps further |
| max_burst_age = 2s | Burst detection window | Matches typical sweep duration on HL |
| burst_threshold = 4 | Min fills for burst | Below this, could be coincidence |

**Backtesting procedure for each parameter:**
1. Replay recorded session logs with parameter sweep
2. Measure: max position, total P&L, fill Sharpe vs equity Sharpe gap, time spent in reduce-only
3. Optimize for: minimize max(position) subject to P&L > 0 and reduce-only time < 30% of session
