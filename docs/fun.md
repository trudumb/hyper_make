Principled Architecture Redesign + Feature Engineering Foundations                                                                                                                                       │
│                                                                                                                                                                                                          │
│ Context                                                                                                                                                                                                  │
│                                                                                                                                                                                                          │
│ Two live mainnet sessions (Feb 12) lost $5.02 and revealed 6 systemic bugs. The root cause is architectural: strategy principles are implemented as overlays on a broken core. Separately, 6 theoretical │
│  alpha sources exist at various stages — 3 production-ready but underutilized, 2 partially wired, 1 missing — but none are structurally integrated into the pipeline.                                    │
│                                                                                                                                                                                                          │
│ This plan treats both the pipeline redesign AND the 6 alpha sources as foundational assumptions — as if the system were designed from scratch with them in mind. The 6 alpha sources aren't features     │
│ bolted onto a pipeline; they ARE the pipeline's sensory inputs, each feeding a specific architectural layer.                                                                                             │
│                                                                                                                                                                                                          │
│ Immediate blocker: Private module path in components.rs prevents compilation.                                                                                                                            │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Alpha Source Audit (Current State)                                                                                                                                                                       │
│                                                                                                                                                                                                          │
│ ┌────────────────────────────┬─────────────────────────┬──────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────┐                           │
│ │        Alpha Source        │         Status          │                     File                     │                                 Gap                                  │                           │
│ ├────────────────────────────┼─────────────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤                           │
│ │ Hawkes trade clustering    │ PRODUCTION (1926 lines) │ process_models/hawkes.rs                     │ Missing: synchronicity coefficient (event density entropy)           │                           │
│ ├────────────────────────────┼─────────────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤                           │
│ │ Cross-venue lead-lag       │ PRODUCTION (703 lines)  │ estimator/cross_venue.rs                     │ Missing: imbalance acceleration (flow convexity)                     │                           │
│ ├────────────────────────────┼─────────────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤                           │
│ │ Funding rate reflexivity   │ PRODUCTION (626 lines)  │ process_models/funding.rs                    │ Missing: basis velocity (spring force before settlement)             │                           │
│ ├────────────────────────────┼─────────────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤                           │
│ │ Queue position survival    │ Paper only              │ simulation/fill_sim.rs                       │ Not wired to live ladder sizing                                      │                           │
│ ├────────────────────────────┼─────────────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤                           │
│ │ Iceberg / hidden liquidity │ Semi-dead               │ adverse_selection/microstructure_features.rs │ Entropy computed but not in FeatureVector; no fill-vs-book detection │                           │
│ ├────────────────────────────┼─────────────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────────┤                           │
│ │ Copula tail dependence     │ Not implemented         │ —                                            │ Multi-asset framework missing entirely                               │                           │
│ └────────────────────────────┴─────────────────────────┴──────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────┘                           │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Target Architecture                                                                                                                                                                                      │
│                                                                                                                                                                                                          │
│ Each alpha source feeds a specific pipeline layer. The regime classifier switches the controller's objective function (mean-revert vs trending/toxic).                                                   │
│                                                                                                                                                                                                          │
│ ┌─────────────────────────────────────────────────────────────┐                                                                                                                                          │
│ │  FEATURE SUBSTRATE (6 alpha sources → normalized features)  │                                                                                                                                          │
│ │                                                             │                                                                                                                                          │
│ │  Hawkes clustering ──→ synchronicity_coeff [0,1]            │                                                                                                                                          │
│ │  Cross-venue ────────→ flow_acceleration [-1,+1]            │                                                                                                                                          │
│ │  Funding ────────────→ basis_velocity [-1,+1]               │                                                                                                                                          │
│ │  Queue position ─────→ conditional_fill_prob [0,1]          │                                                                                                                                          │
│ │  Iceberg detection ──→ hidden_liquidity_ratio [0,1]         │                                                                                                                                          │
│ │  (Copula ────────────→ tail_dependence [0,1]) FUTURE        │                                                                                                                                          │
│ └───────────┬─────────────────────────────────────────────────┘                                                                                                                                          │
│             │                                                                                                                                                                                            │
│ ┌───────────▼─────────────────────────────────────────────────┐                                                                                                                                          │
│ │  L1: INVENTORY GOVERNOR (hard ceiling)                      │                                                                                                                                          │
│ │  config.max_position ALWAYS. Zones: Green/Yellow/Red/Kill   │                                                                                                                                          │
│ │  (Future: copula tail spike → tighten zones dynamically)    │                                                                                                                                          │
│ └───────────┬─────────────────────────────────────────────────┘                                                                                                                                          │
│             │                                                                                                                                                                                            │
│ ┌───────────▼─────────────────────────────────────────────────┐                                                                                                                                          │
│ │  L2: REGIME CLASSIFIER (objective switcher)                 │                                                                                                                                          │
│ │  HMM + Hawkes branching ratio + funding stress              │                                                                                                                                          │
│ │  Regime A (Mean Revert): tight spread, high skew gain       │                                                                                                                                          │
│ │  Regime B (Trending/Toxic): wide spread, minimize inventory │                                                                                                                                          │
│ │  → Switches RegimeParams AND controller objective           │                                                                                                                                          │
│ └───────────┬─────────────────────────────────────────────────┘                                                                                                                                          │
│             │                                                                                                                                                                                            │
│ ┌───────────▼─────────────────────────────────────────────────┐                                                                                                                                          │
│ │  L3: SPREAD ENGINE                                          │                                                                                                                                          │
│ │  solve_min_gamma(fee + AS_expected + risk_premium)          │                                                                                                                                          │
│ │  Hawkes intensity → additive risk_premium                   │                                                                                                                                          │
│ │  Hidden liquidity → tighter when iceberg support detected   │                                                                                                                                          │
│ │  NO floor. NO multiplier chain. Math produces answer.       │                                                                                                                                          │
│ └───────────┬─────────────────────────────────────────────────┘                                                                                                                                          │
│             │                                                                                                                                                                                            │
│ ┌───────────▼─────────────────────────────────────────────────┐                                                                                                                                          │
│ │  L4: ASYMMETRIC PRICER                                      │                                                                                                                                          │
│ │  inventory_skew = -(pos/max) × skew_gain × half_spread      │                                                                                                                                          │
│ │  Cross-venue acceleration → directional lean                │                                                                                                                                          │
│ │  Funding basis velocity → settlement lean                   │                                                                                                                                          │
│ │  Skew scales with half_spread. ALWAYS active.               │                                                                                                                                          │
│ └───────────┬─────────────────────────────────────────────────┘                                                                                                                                          │
│             │                                                                                                                                                                                            │
│ ┌───────────▼─────────────────────────────────────────────────┐                                                                                                                                          │
│ │  L5: RISK OVERLAY (graduated, never cancel-all)             │                                                                                                                                          │
│ │  Changepoint → spread_mult [1.0, 3.0]                      │                                                                                                                                           │
│ │  Only kill switch can cancel all. Reduce-only preserved.    │                                                                                                                                          │
│ └───────────┬─────────────────────────────────────────────────┘                                                                                                                                          │
│             │                                                                                                                                                                                            │
│ ┌───────────▼─────────────────────────────────────────────────┐                                                                                                                                          │
│ │  L6: LADDER GENERATOR                                       │                                                                                                                                          │
│ │  Queue survival prob → size per level (front=full, back=min)│                                                                                                                                          │
│ │  Fill probability → skip levels with P(fill) < threshold    │                                                                                                                                          │
│ │  Zone-aware: Red=reduce-only, Yellow=wider increasing side  │                                                                                                                                          │
│ └─────────────────────────────────────────────────────────────┘                                                                                                                                          │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Implementation Phases                                                                                                                                                                                    │
│                                                                                                                                                                                                          │
│ Phase 0: Fix Compilation (Lead, 1 min)                                                                                                                                                                   │
│                                                                                                                                                                                                          │
│ core/components.rs uses private path process_models::hawkes::HawkesExcitationPredictor. The module is mod hawkes; (private) but re-exported via pub use hawkes::*; in process_models/mod.rs:17.          │
│                                                                                                                                                                                                          │
│ - Line 609: → crate::market_maker::HawkesExcitationPredictor                                                                                                                                             │
│ - Line 734: → crate::market_maker::HawkesExcitationPredictor::default()                                                                                                                                  │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 1: Feature Substrate — Enhance 3 Existing Alpha Sources (signals + analytics)                                                                                                                      │
│                                                                                                                                                                                                          │
│ Extend the 3 production-ready sources with the missing theoretical components. All changes are additive — no rewiring, just richer features.                                                             │
│                                                                                                                                                                                                          │
│ 1A: Hawkes Synchronicity Coefficient (signals)                                                                                                                                                           │
│                                                                                                                                                                                                          │
│ Theory: Toxic flow arrives in bursts. Five medium sells from different sources in 50ms is more dangerous than one large sell. Measure event density entropy.                                             │
│                                                                                                                                                                                                          │
│ What exists: HawkesExcitationPredictor in process_models/hawkes.rs already computes branching ratio, cluster probability, intensity percentiles.                                                         │
│                                                                                                                                                                                                          │
│ What to add (to hawkes.rs):                                                                                                                                                                              │
│ /// Synchronicity: time-decayed density of unique trade events in burst window                                                                                                                           │
│ /// High synchronicity (many trades, low inter-arrival entropy) = informed flow                                                                                                                          │
│ pub fn synchronicity_coefficient(&self) -> f64 {                                                                                                                                                         │
│     // Entropy of inter-arrival times in recent burst window (100ms)                                                                                                                                     │
│     // Low entropy = regular spacing = algorithmic = toxic                                                                                                                                               │
│     // High entropy = random spacing = noise                                                                                                                                                             │
│     let entropy = self.inter_arrival_entropy();                                                                                                                                                          │
│     let density = self.recent_event_count as f64 / BURST_WINDOW_SECS;                                                                                                                                    │
│     (1.0 - entropy.min(1.0)) * (density / self.baseline_density).min(1.0)                                                                                                                                │
│ }                                                                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ Files: process_models/hawkes.rs (signals owns process_models? No — strategy owns. But hawkes is a signal source. Lead coordinates.)                                                                      │
│                                                                                                                                                                                                          │
│ 1B: Cross-Venue Flow Acceleration (signals)                                                                                                                                                              │
│                                                                                                                                                                                                          │
│ Theory: Don't just track Binance price — track the acceleration of imbalance. Accelerating imbalance on lead exchange = sweep incoming on local.                                                         │
│                                                                                                                                                                                                          │
│ What exists: CrossVenueAnalyzer in estimator/cross_venue.rs tracks agreement, divergence, intensity ratio.                                                                                               │
│                                                                                                                                                                                                          │
│ What to add (to cross_venue.rs):                                                                                                                                                                         │
│ /// Flow acceleration: d(imbalance)/dt on lead venue                                                                                                                                                     │
│ /// Positive acceleration + positive imbalance = buying sweep imminent                                                                                                                                   │
│ pub fn flow_acceleration(&self) -> f64 {                                                                                                                                                                 │
│     // Difference of 1s vs 5s EWMA imbalance on lead venue                                                                                                                                               │
│     let imb_fast = self.binance_imbalance_1s;                                                                                                                                                            │
│     let imb_slow = self.binance_imbalance_5s;                                                                                                                                                            │
│     (imb_fast - imb_slow).clamp(-1.0, 1.0)  // acceleration direction                                                                                                                                    │
│ }                                                                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ Files: estimator/cross_venue.rs (signals owns estimator/)                                                                                                                                                │
│                                                                                                                                                                                                          │
│ 1C: Funding Basis Velocity (signals)                                                                                                                                                                     │
│                                                                                                                                                                                                          │
│ Theory: As funding approaches settlement, arb traders rebalance. The "spring force" (basis velocity toward zero) predicts when bleed becomes cascade.                                                    │
│                                                                                                                                                                                                          │
│ What exists: FundingRateEstimator in process_models/funding.rs tracks EWMA funding, premium, predicted rate.                                                                                             │
│                                                                                                                                                                                                          │
│ What to add (to funding.rs):                                                                                                                                                                             │
│ /// Basis velocity: rate of change of mark-index spread                                                                                                                                                  │
│ /// High velocity near settlement = forced rebalancing imminent                                                                                                                                          │
│ pub fn basis_velocity(&self) -> f64 {                                                                                                                                                                    │
│     let basis_now = self.mark_price - self.index_price;                                                                                                                                                  │
│     let basis_prev = self.prev_basis;  // 1-minute ago                                                                                                                                                   │
│     let velocity = (basis_now - basis_prev) / 60.0;  // per second                                                                                                                                       │
│     // Scale by proximity to settlement (8h cycle)                                                                                                                                                       │
│     let settlement_proximity = self.time_to_settlement_fraction(); // 0=now, 1=far                                                                                                                       │
│     velocity * (1.0 / (settlement_proximity + 0.1))  // amplify near settlement                                                                                                                          │
│ }                                                                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ Files: process_models/funding.rs (strategy owns process_models/)                                                                                                                                         │
│                                                                                                                                                                                                          │
│ 1D: Update FeatureVector (analytics)                                                                                                                                                                     │
│                                                                                                                                                                                                          │
│ What exists: FeatureVector in strategy/feature_store.rs with 4 features (flow_toxicity, flow_direction, book_thinning, funding_pressure).                                                                │
│                                                                                                                                                                                                          │
│ What to add: 3 new features to FeatureVector:                                                                                                                                                            │
│ pub synchronicity: NormalizedFeature,      // from Hawkes 1A                                                                                                                                             │
│ pub flow_acceleration: NormalizedFeature,   // from cross-venue 1B                                                                                                                                       │
│ pub basis_velocity: NormalizedFeature,      // from funding 1C                                                                                                                                           │
│                                                                                                                                                                                                          │
│ Update directional_signal() weights to incorporate new features.                                                                                                                                         │
│                                                                                                                                                                                                          │
│ Files: strategy/feature_store.rs (strategy owns)                                                                                                                                                         │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 2: Wire Iceberg Detection + Queue Survival (signals + analytics)                                                                                                                                   │
│                                                                                                                                                                                                          │
│ Two partially-implemented sources need activation.                                                                                                                                                       │
│                                                                                                                                                                                                          │
│ 2A: Hidden Liquidity Detection (signals)                                                                                                                                                                 │
│                                                                                                                                                                                                          │
│ Theory: If a 10 BTC order fills at the bid but bid size only decreases 2 BTC, there's hidden depth. High hidden ratio on one side = support floor = quote tighter.                                       │
│                                                                                                                                                                                                          │
│ What exists: Size entropy and direction entropy in adverse_selection/microstructure_features.rs (computed but not in FeatureVector). adverse_selection/book_dynamics.rs (337 lines, newly created)       │
│ likely has L2 tracking.                                                                                                                                                                                  │
│                                                                                                                                                                                                          │
│ What to add (to adverse_selection/book_dynamics.rs or new):                                                                                                                                              │
│ /// Track fill-vs-book discrepancy to detect iceberg orders                                                                                                                                              │
│ pub struct IcebergDetector {                                                                                                                                                                             │
│     /// EWMA of (fill_size - book_size_decrease) / fill_size at each price level                                                                                                                         │
│     hidden_ratio_bid: f64,  // [0, 1] — 0=no hidden, 1=all hidden                                                                                                                                        │
│     hidden_ratio_ask: f64,                                                                                                                                                                               │
│ }                                                                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ impl IcebergDetector {                                                                                                                                                                                   │
│     /// Called on every L2 update after a fill at a price level                                                                                                                                          │
│     pub fn on_fill_with_book_update(&mut self, side: Side, fill_size: f64, book_decrease: f64) {                                                                                                         │
│         let hidden_frac = ((fill_size - book_decrease) / fill_size).max(0.0);                                                                                                                            │
│         match side {                                                                                                                                                                                     │
│             Side::Buy => self.hidden_ratio_bid = ewma(self.hidden_ratio_bid, hidden_frac, 0.05),                                                                                                         │
│             Side::Sell => self.hidden_ratio_ask = ewma(self.hidden_ratio_ask, hidden_frac, 0.05),                                                                                                        │
│         }                                                                                                                                                                                                │
│     }                                                                                                                                                                                                    │
│                                                                                                                                                                                                          │
│     /// High ratio = hidden support = can quote tighter on that side                                                                                                                                     │
│     pub fn hidden_liquidity_ratio(&self, side: Side) -> f64 { ... }                                                                                                                                      │
│ }                                                                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ Feeds: L3 Spread Engine — when hidden ratio high on both sides, reduce risk_premium_bps (support detected).                                                                                              │
│                                                                                                                                                                                                          │
│ Files: adverse_selection/book_dynamics.rs (signals owns adverse_selection/)                                                                                                                              │
│                                                                                                                                                                                                          │
│ 2B: Queue Position → Live Ladder Sizing (analytics + infra)                                                                                                                                              │
│                                                                                                                                                                                                          │
│ Theory: Map volume ahead of you into a survival curve. If depth ahead is thinning from cancellations (not fills), your fill risk increases while spread reward decreases — signal to modify to deeper    │
│ level.                                                                                                                                                                                                   │
│                                                                                                                                                                                                          │
│ What exists: QueuePositionEstimator in simulation/fill_sim.rs with queue fraction tracking, touch fill probability, queue alpha. Works in paper trading. NOT wired to live.                              │
│                                                                                                                                                                                                          │
│ What to add:                                                                                                                                                                                             │
│ 1. Wire conditional_fill_probability from QueuePositionEstimator into live LadderGenerator                                                                                                               │
│ 2. Size per level = base_size × P(fill)^alpha — front of queue gets full size, back gets minimal                                                                                                         │
│ 3. Skip levels where P(fill) < min_threshold (avoid wasting order slots)                                                                                                                                 │
│ 4. Track depth thinning rate (cancellation vs fill) as early warning                                                                                                                                     │
│                                                                                                                                                                                                          │
│ Files: simulation/fill_sim.rs (analytics owns simulation/), strategy/ladder_strat.rs (strategy), orchestrator/quote_engine.rs (infra for wiring)                                                         │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 3: Inventory Governor as Hard Ceiling (risk + infra)                                                                                                                                               │
│                                                                                                                                                                                                          │
│ Goal: config.max_position is the HARD ceiling. InventoryGovernor.assess() is the FIRST check in every quote cycle.                                                                                       │
│                                                                                                                                                                                                          │
│ What exists: risk/inventory_governor.rs with 4 zones (Green/Yellow/Red/Kill), 19 tests. Wired at order placement and reconciliation, but NOT at top of quote cycle.                                      │
│                                                                                                                                                                                                          │
│ File: orchestrator/quote_engine.rs                                                                                                                                                                       │
│ Owner: infra                                                                                                                                                                                             │
│ Change: Add inventory_governor.assess(position) as first check. Kill → cancel + return. Pass PositionAssessment downstream. DELETE effective_max_position from margin (lines ~376-416). Replace with     │
│   self.config.max_position. Remove proactive_max_position override.                                                                                                                                      │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: strategy/market_params.rs                                                                                                                                                                          │
│ Owner: strategy                                                                                                                                                                                          │
│ Change: Add position_zone: PositionZone, max_new_exposure: f64. Remove margin-derived position limit methods.                                                                                            │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: risk/inventory_governor.rs                                                                                                                                                                         │
│ Owner: risk                                                                                                                                                                                              │
│ Change: Add zone_adjusted_max(regime_fraction: f64) -> f64 for regime tightening.                                                                                                                        │
│                                                                                                                                                                                                          │
│ Validation: Paper trade — position never exceeds config.max_position.                                                                                                                                    │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 4: Regime Classifier as Objective Switcher (strategy + infra)                                                                                                                                      │
│                                                                                                                                                                                                          │
│ Goal: Regime doesn't just select parameters — it switches the controller's objective function. Mean-revert regime maximizes spread capture. Trending/toxic regime minimizes inventory at all costs.      │
│                                                                                                                                                                                                          │
│ What exists: RegimeHMM (4 states, 6 features, auto-calibrating, LIVE). RegimeState (hysteresis, params per regime, LIVE). But RegimeParams fields like spread_floor_bps, skew_gain, size_multiplier are  │
│ dead — never consumed downstream.                                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ File: strategy/regime_state.rs                                                                                                                                                                           │
│ Owner: strategy                                                                                                                                                                                          │
│ Change: Add as_expected_bps: f64, risk_premium_bps: f64 to RegimeParams. Add controller_objective: ControllerObjective enum (MeanRevert / TrendingToxic). Add update_as_from_markout() EWMA. Enhanced    │
│   regime features: Hawkes synchronicity_coefficient > 0.7 forces Volatile+. Funding basis_velocity extreme forces re-evaluation.                                                                         │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: strategy/market_params.rs                                                                                                                                                                          │
│ Owner: strategy                                                                                                                                                                                          │
│ Change: Add all regime fields: regime_as_expected_bps, regime_risk_premium_bps, regime_skew_gain, regime_size_multiplier, controller_objective.                                                          │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: orchestrator/quote_engine.rs                                                                                                                                                                       │
│ Owner: infra                                                                                                                                                                                             │
│ Change: After regime_state.update(), populate ALL market_params regime fields. Wire max_position_fraction to InventoryGovernor tightening (Extreme → 30% of max).                                        │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: orchestrator/handlers.rs                                                                                                                                                                           │
│ Owner: infra                                                                                                                                                                                             │
│ Change: In check_pending_fill_outcomes(), feed markout_as_bps to regime_state.update_as_from_markout(). Closes measurement→regime loop.                                                                  │
│                                                                                                                                                                                                          │
│ Regime → Objective Mapping:                                                                                                                                                                              │
│ Calm/Normal  → MeanRevert:    skew_gain=1.5, risk_premium=0.5-1.0, size_mult=1.0                                                                                                                         │
│ Volatile     → TrendingToxic: skew_gain=0.5, risk_premium=2.0-4.0, size_mult=0.5                                                                                                                         │
│ Extreme      → TrendingToxic: skew_gain=0.3, risk_premium=4.0-8.0, size_mult=0.3                                                                                                                         │
│                                                                                                                                                                                                          │
│ MeanRevert objective: Maximize spread_captured - AS - fee. Tight spreads, aggressive inventory skew to revert, high fill rate target.                                                                    │
│                                                                                                                                                                                                          │
│ TrendingToxic objective: Minimize |position| × time_held. Wide spreads, defensive, reduce-only bias, low fill rate acceptable.                                                                           │
│                                                                                                                                                                                                          │
│ Dependencies: Phase 3 (governor for regime tightening)                                                                                                                                                   │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 5: Self-Consistent Spread Engine (strategy + infra)                                                                                                                                                │
│                                                                                                                                                                                                          │
│ Goal: Replace 7-deep multiplicative chain with solve_min_gamma(fee + AS_expected + risk_premium). GLFT produces correct spread by construction.                                                          │
│                                                                                                                                                                                                          │
│ What exists: solve_min_gamma in glft.rs:171-230 works. But output clamped by adaptive_spread_floor and multiplied by 7 factors.                                                                          │
│                                                                                                                                                                                                          │
│ File: orchestrator/quote_engine.rs                                                                                                                                                                       │
│ Owner: infra                                                                                                                                                                                             │
│ Change: DELETE 7-multiplier block (lines ~1084-1227). Replace with additive total_risk_premium_bps = regime risk_premium + hawkes intensity addon (0-3 bps when synchronicity > 0.5) + toxicity addon    │
│ (0-5                                                                                                                                                                                                     │
│   bps when score > 0.5) + staleness addon (0-3 bps). Keep ONE risk_overlay_mult (Phase 7), capped 3x. NEW: Hidden liquidity discount — when iceberg_ratio > 0.3 on both sides, reduce risk_premium by    │
│ 20%                                                                                                                                                                                                      │
│   (detected support).                                                                                                                                                                                    │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: strategy/ladder_strat.rs                                                                                                                                                                           │
│ Owner: strategy                                                                                                                                                                                          │
│ Change: DELETE floor clamp (~line 870). Compute target_floor_bps = fee(1.5) + regime.as_expected_bps + total_risk_premium_bps. Pass to solve_min_gamma(). GLFT output IS the spread. Remove              │
│   adaptive_spread_floor, effective_spread_floor, conditional_as_buffer_bps.                                                                                                                              │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: strategy/glft.rs                                                                                                                                                                                   │
│ Owner: strategy                                                                                                                                                                                          │
│ Change: No changes to solve_min_gamma. Ensure half_spread() uses regime gamma.                                                                                                                           │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: strategy/market_params.rs                                                                                                                                                                          │
│ Owner: strategy                                                                                                                                                                                          │
│ Change: Remove spread_widening_mult, adaptive_spread_floor, adaptive_kappa. Add total_risk_premium_bps: f64.                                                                                             │
│                                                                                                                                                                                                          │
│ How alpha sources feed spread:                                                                                                                                                                           │
│ - Hawkes synchronicity high → additive risk_premium increase (cluster danger)                                                                                                                            │
│ - Hidden liquidity high → risk_premium discount (iceberg support detected)                                                                                                                               │
│ - Regime kappa → directly in solve_min_gamma(kappa) (higher kappa = tighter spread)                                                                                                                      │
│ - AS from markout EWMA → directly in target_floor                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ Validation: Floor binding rate drops from ~100% to <5%.                                                                                                                                                  │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 6: Asymmetric Pricer with Alpha-Driven Skew (strategy + signals)                                                                                                                                   │
│                                                                                                                                                                                                          │
│ Goal: Skew always active, scaled by GLFT half_spread, driven by alpha sources.                                                                                                                           │
│                                                                                                                                                                                                          │
│ What exists: Skew in signal_integration.rs is ~0 for 99.8% of cycles. Clamped to market_spread * 0.5.                                                                                                    │
│                                                                                                                                                                                                          │
│ ┌────────────────────────────────┬──────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐                 │
│ │              File              │  Owner   │                                                                  Change                                                                  │                 │
│ ├────────────────────────────────┼──────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                 │
│ │ strategy/ladder_strat.rs       │ strategy │ Change skew clamp: market_spread * 0.5 → glft_half_spread * 0.8.                                                                         │                 │
│ ├────────────────────────────────┼──────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤                 │
│ │ strategy/signal_integration.rs │ signals  │ set_skew_context() receives glft_half_spread_bps. Inventory skew = -(pos/max) × regime.skew_gain × half_spread_bps. Signal skew sources: │                 │
│ └────────────────────────────────┴──────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘                 │
│                                                                                                                                                                                                          │
│ Alpha sources → skew mapping:                                                                                                                                                                            │
│ inventory_skew = -(position/max) × skew_gain × half_spread_bps     [ALWAYS active]                                                                                                                       │
│ cross_venue_skew = flow_acceleration × 0.3 × half_spread_bps       [acceleration, not level]                                                                                                             │
│ funding_skew = basis_velocity × 0.15 × half_spread_bps             [amplified near settlement]                                                                                                           │
│ flow_skew = trade_flow_imbalance_5s × 0.2 × half_spread_bps        [existing TradeFlowTracker]                                                                                                           │
│                                                                                                                                                                                                          │
│ total_skew = clamp(sum, -0.8 × half_spread, +0.8 × half_spread)                                                                                                                                          │
│ skewed_mid = mid + total_skew / 10000                                                                                                                                                                    │
│                                                                                                                                                                                                          │
│ Regime modulation: In MeanRevert, skew_gain = 1.5 (aggressive inventory reduction). In TrendingToxic, skew_gain = 0.3 (defensive, don't fight the trend).                                                │
│                                                                                                                                                                                                          │
│ Dependencies: Phase 5 (need GLFT half_spread before skew)                                                                                                                                                │
│                                                                                                                                                                                                          │
│ Validation: skew_bps != 0 whenever position != 0.                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 7: Graduated Risk Overlay (risk + infra)                                                                                                                                                           │
│                                                                                                                                                                                                          │
│ Goal: Only kill switch can cancel all quotes. Everything else widens or reduces size.                                                                                                                    │
│                                                                                                                                                                                                          │
│ File: orchestrator/quote_engine.rs                                                                                                                                                                       │
│ Owner: infra                                                                                                                                                                                             │
│ Change: Circuit breaker CancelAllQuotes → spread_mult *= 5.0, continue. Drawdown pause → 10% size + 3x spread, continue. Quote gate NoQuote → 3x spread + reduce-only, continue.                         │
│ ────────────────────────────────────────                                                                                                                                                                 │
│ File: strategy/ladder_strat.rs                                                                                                                                                                           │
│ Owner: strategy                                                                                                                                                                                          │
│ Change: Zone-aware: Kill→empty, Red→reduce-only, Yellow→wider increasing side + smaller size, Green→normal. Queue survival: size_per_level = base × P(fill)^0.5 from Phase 2B.                           │
│                                                                                                                                                                                                          │
│ Validation: Quoting uptime >80% (was 12%).                                                                                                                                                               │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Phase 8: Clean Up Measurement Substrate (analytics + infra)                                                                                                                                              │
│                                                                                                                                                                                                          │
│ Goal: All edge learning uses markout-based AS exclusively.                                                                                                                                               │
│                                                                                                                                                                                                          │
│ ┌───────────────────────────┬───────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────┐                                                         │
│ │           File            │   Owner   │                                                Change                                                │                                                         │
│ ├───────────────────────────┼───────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                         │
│ │ orchestrator/handlers.rs  │ infra     │ Move adaptive_spreads.on_fill_simple() from fill-time to check_pending_fill_outcomes() (markout AS). │                                                         │
│ ├───────────────────────────┼───────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────┤                                                         │
│ │ analytics/edge_metrics.rs │ analytics │ Verify only Resolved snapshots processed.                                                            │                                                         │
│ └───────────────────────────┴───────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────┘                                                         │
│                                                                                                                                                                                                          │
│ Validation: Edge distribution mean ~2-5 bps (not ~0).                                                                                                                                                    │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Team Structure                                                                                                                                                                                           │
│                                                                                                                                                                                                          │
│ ┌───────────┬────────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐               │
│ │   Agent   │       Phases       │                                                                       Key Files                                                                       │               │
│ ├───────────┼────────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤               │
│ │ signals   │ 1A, 1B, 2A, 6      │ process_models/hawkes.rs, estimator/cross_venue.rs, adverse_selection/book_dynamics.rs, strategy/signal_integration.rs                                │               │
│ ├───────────┼────────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤               │
│ │ strategy  │ 1C, 1D, 4, 5, 6, 7 │ process_models/funding.rs, strategy/feature_store.rs, strategy/regime_state.rs, strategy/glft.rs, strategy/ladder_strat.rs, strategy/market_params.rs │               │
│ ├───────────┼────────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤               │
│ │ infra     │ 3, 4, 5, 6, 7, 8   │ orchestrator/quote_engine.rs, orchestrator/handlers.rs, core/components.rs                                                                            │               │
│ ├───────────┼────────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤               │
│ │ risk      │ 3                  │ risk/inventory_governor.rs                                                                                                                            │               │
│ ├───────────┼────────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤               │
│ │ analytics │ 2B, 8              │ simulation/fill_sim.rs, analytics/edge_metrics.rs, learning/ consumers                                                                                │               │
│ └───────────┴────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘               │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Execution Order                                                                                                                                                                                          │
│                                                                                                                                                                                                          │
│ Phase 0:  Lead ──────── Fix compilation (1 min)                                                                                                                                                          │
│ Phase 1:  signals+strategy ─── Enhance 3 alpha sources (parallel)                                                                                                                                        │
│ Phase 2:  signals+analytics ── Wire iceberg + queue (parallel with 1)                                                                                                                                    │
│ Phase 8:  analytics+infra ──── Clean measurement (parallel with 1,2)                                                                                                                                     │
│           ─────────────────────────────────────────────────                                                                                                                                              │
│ Phase 3:  risk+infra ───────── Inventory governor (after 0)                                                                                                                                              │
│ Phase 4:  strategy+infra ───── Regime classifier (after 3)                                                                                                                                               │
│ Phase 5:  strategy+infra ───── Spread engine (after 4)                                                                                                                                                   │
│ Phase 7:  risk+infra ───────── Risk overlay (after 5)                                                                                                                                                    │
│ Phase 6:  strategy+signals ─── Asymmetric pricer (after 5)                                                                                                                                               │
│                                                                                                                                                                                                          │
│ Critical path: 0 → 3 → 4 → 5 → 6 (pipeline rewiring)                                                                                                                                                     │
│ Parallel track: 1 + 2 + 8 (feature enrichment, no pipeline dependencies)                                                                                                                                 │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ Verification                                                                                                                                                                                             │
│                                                                                                                                                                                                          │
│ cargo clippy -- -D warnings   # Clean                                                                                                                                                                    │
│ cargo test --lib               # All pass                                                                                                                                                                │
│                                                                                                                                                                                                          │
│ Success metrics (paper trading):                                                                                                                                                                         │
│                                                                                                                                                                                                          │
│ ┌───────────────────────────┬──────────────┬─────────┐                                                                                                                                                   │
│ │          Metric           │   Current    │ Target  │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Floor binding rate        │ ~100%        │ <5%     │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Skew != 0 when pos != 0   │ 0.2%         │ 100%    │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Position / max            │ 3.95x breach │ <= 1.0x │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Quoting uptime            │ 12%          │ >80%    │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Edge prediction R²        │ ~0           │ >0.1    │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Regime kappa consumed     │ No           │ Yes     │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Alpha sources active      │ 3 of 6       │ 6 of 6  │                                                                                                                                                   │
│ ├───────────────────────────┼──────────────┼─────────┤                                                                                                                                                   │
│ │ Regime switches objective │ No           │ Yes     │                                                                                                                                                   │
│ └───────────────────────────┴──────────────┴─────────┘                                                                                                                                                   │
│                                                                                                                                                                                                          │
│ ---                                                                                                                                                                                                      │
│ What Gets Deleted                                                                                                                                                                                        │
│                                                                                                                                                                                                          │
│ ┌─────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────┐                                                                            │
│ │                       Current                       │                             Replacement                             │                                                                            │
│ ├─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                                                                            │
│ │ effective_max_position from margin                  │ config.max_position always                                          │                                                                            │
│ ├─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                                                                            │
│ │ 7-deep spread multiplier chain                      │ solve_min_gamma(fee + AS + risk_premium) + single risk overlay mult │                                                                            │
│ ├─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                                                                            │
│ │ adaptive_spread_floor / conditional_as_buffer_bps   │ Regime as_expected_bps from markout EWMA                            │                                                                            │
│ ├─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                                                                            │
│ │ Emergency cancel-all (78/89 min lockout)            │ Graduated widening, reduce-only preserved                           │                                                                            │
│ ├─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                                                                            │
│ │ Margin-split directional (skew → margin, not price) │ Actual price skew via half_spread scaling                           │                                                                            │
│ ├─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                                                                            │
│ │ InformedFlow tightening (-0.23 bps)                 │ Removed entirely                                                    │                                                                            │
│ ├─────────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                                                                            │
│ │ Fill-time AS computation                            │ Deferred to 5s markout exclusively                                  │                                                                            │
│ └─────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────┘                                                                            │
│                                                                                                                                                                                                          │
│ What Gets Kept                                                                                                                                                                                           │
│                                                                                                                                                                                                          │
│ ┌─────────────────────────────┬───────────────────────────────────────────────────────┐                                                                                                                  │
│ │           Module            │                          Why                          │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ glft.rs + solve_min_gamma   │ Core math correct, needs correct inputs               │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ kappa_orchestrator.rs       │ Robust kappa estimation works                         │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ RegimeHMM                   │ 4-state detection with auto-calibration works         │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ HawkesExcitationPredictor   │ Production-ready, extend with synchronicity           │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ CrossVenueAnalyzer          │ Production-ready, extend with acceleration            │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ FundingRateEstimator        │ Production-ready, extend with basis velocity          │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ InventoryGovernor           │ 4 zones, 19 tests, wire as first check                │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ SpreadBandit                │ Contextual bandit works, feeds from improved features │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ kill_switch.rs              │ Hard limits correct                                   │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ TradeFlowTracker            │ 4-horizon EWMA works                                  │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ quoting/ladder/generator.rs │ Entropy optimizer, geometric spacing work             │                                                                                                                  │
│ ├─────────────────────────────┼───────────────────────────────────────────────────────┤                                                                                                                  │
│ │ Checkpoint system           │ Add new fields with #[serde(default)]                 │                                                                                                                  │
│ └─────────────────────────────┴───────────────────────────────────────────────────────┘                                                                                                                  │
│                                                                                                                                                                                                          │
│ Future Work (Not In This Plan)                                                                                                                                                                           │
│                                                                                                                                                                                                          │
│ - Copula tail dependence: Needs multi-asset data pipeline. Would feed L1 (governor tightens when systemic risk spikes) and L5 (risk overlay). Research item.                                             │
│ - Wallet clustering for synchronicity: Needs on-chain data feed. Would enhance Hawkes synchronicity coefficient.                                                                                         │
│ - Multi-asset inventory optimization: Needs copula framework + cross-asset hedging.