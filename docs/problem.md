# Plan: Replace Arbitrary Quote Gate with Calibrated Signal Infrastructure                                                                                                                               
                                                                                                                                                                                                           
  ## The Problem                                                                                                                                                                                           
                                                                                                                                                                                                           
  Current quote gate uses **arbitrary thresholds**:                                                                                                                                                        
  ```rust                                                                                                                                                                                                  
  if flow_imbalance > 0.15 { quote }  // Why 0.15? Nobody knows.                                                                                                                                           
  ```                                                                                                                                                                                                      
                                                                                                                                                                                                           
  Your log shows `flow_imbalance = 0.105` → NoQuote. But is 0.105 actually predictive? We don't know because we're not measuring it.                                                                       
                                                                                                                                                                                                           
  ## What You Already Have (90% complete)                                                                                                                                                                  
                                                                                                                                                                                                           
  | Component | Location | Status |                                                                                                                                                                        
  |-----------|----------|--------|                                                                                                                                                                        
  | **PredictionLog** | `calibration/prediction_log.rs` | ✅ Records predictions with metadata |                                                                                                           
  | **InformationRatioTracker** | `calibration/information_ratio.rs` | ✅ IR > 1.0 = adds value |                                                                                                          
  | **BrierScoreTracker** | `calibration/brier_score.rs` | ✅ Probability calibration |                                                                                                                    
  | **SignalQualityTracker** | `estimator/mutual_info.rs` | ✅ MI decay, half-life |                                                                                                                       
  | **DecisionEngine** | `learning/decision.rs` | ✅ Formal EV-based decisions |                                                                                                                           
  | **LearningModule** | `learning/mod.rs` | ✅ Closed-loop prediction → outcome |                                                                                                                         
  | **ConditionalCalibration** | `calibration/conditional_metrics.rs` | ✅ Slice by regime |                                                                                                               
                                                                                                                                                                                                           
  ## What's Missing: The Wiring                                                                                                                                                                            
                                                                                                                                                                                                           
  `flow_imbalance` is captured but **not measured for predictive power**. The quote gate uses a hardcoded threshold instead of asking: "Does this signal actually predict fills?"                          
                                                                                                                                                                                                           
  ---                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ## The Fix: Calibrated Quote Gate                                                                                                                                                                        
                                                                                                                                                                                                           
  ### Principle: No Arbitrary Thresholds                                                                                                                                                                   
                                                                                                                                                                                                           
  Instead of: `if signal > threshold { act }`                                                                                                                                                              
                                                                                                                                                                                                           
  Use: `if IR(signal → outcome) > 1.0 { use signal weighted by IR }`                                                                                                                                       
                                                                                                                                                                                                           
  ### Phase 1: Measure Flow Imbalance Predictive Power                                                                                                                                                     
                                                                                                                                                                                                           
  **Goal**: Answer "When flow_imbalance = X, what's P(favorable fill)?"                                                                                                                                    
                                                                                                                                                                                                           
  **File**: `src/market_maker/tracking/calibration_wiring.rs`                                                                                                                                              
                                                                                                                                                                                                           
  Add `CalibratedFlowImbalance`:                                                                                                                                                                           
  ```rust                                                                                                                                                                                                  
  pub struct CalibratedFlowImbalance {                                                                                                                                                                     
  /// Prediction tracker for flow_imbalance → fill direction                                                                                                                                               
  prediction_tracker: PredictionTracker,                                                                                                                                                                   
  /// Information ratio: does flow_imbalance predict fill direction?                                                                                                                                       
  ir_tracker: InformationRatioTracker,                                                                                                                                                                     
  /// MI tracker for decay detection                                                                                                                                                                       
  mi_tracker: SignalMiTracker,                                                                                                                                                                             
  }                                                                                                                                                                                                        
                                                                                                                                                                                                           
  impl CalibratedFlowImbalance {                                                                                                                                                                           
  /// Record prediction at quote time                                                                                                                                                                      
  pub fn predict(&mut self, flow_imbalance: f64, regime: Regime) -> PredictionId {                                                                                                                         
  // Prediction: P(fill_direction matches sign of flow_imbalance)                                                                                                                                          
  let predicted_prob = self.signal_to_probability(flow_imbalance);                                                                                                                                         
  self.prediction_tracker.record(predicted_prob, regime)                                                                                                                                                   
  }                                                                                                                                                                                                        
                                                                                                                                                                                                           
  /// Record outcome when fill happens                                                                                                                                                                     
  pub fn record_outcome(&mut self, pred_id: PredictionId, fill_was_favorable: bool) {                                                                                                                      
  self.prediction_tracker.resolve(pred_id, fill_was_favorable);                                                                                                                                            
  self.ir_tracker.update(...);                                                                                                                                                                             
  }                                                                                                                                                                                                        
                                                                                                                                                                                                           
  /// Is this signal worth using?                                                                                                                                                                          
  pub fn is_predictive(&self) -> bool {                                                                                                                                                                    
  self.ir_tracker.information_ratio() > 1.0                                                                                                                                                                
  }                                                                                                                                                                                                        
                                                                                                                                                                                                           
  /// Signal weight based on IR (higher IR = more weight)                                                                                                                                                  
  pub fn signal_weight(&self) -> f64 {                                                                                                                                                                     
  (self.ir_tracker.information_ratio() - 1.0).max(0.0)                                                                                                                                                     
  }                                                                                                                                                                                                        
  }                                                                                                                                                                                                        
  ```                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ### Phase 2: Replace Quote Gate Logic                                                                                                                                                                    
                                                                                                                                                                                                           
  **File**: `src/market_maker/control/quote_gate.rs`                                                                                                                                                       
                                                                                                                                                                                                           
  Old (arbitrary):                                                                                                                                                                                         
  ```rust                                                                                                                                                                                                  
  let has_edge = flow_imbalance.abs() > self.config.min_edge_signal;                                                                                                                                       
  if !has_edge && is_flat {                                                                                                                                                                                
  return NoQuote;                                                                                                                                                                                          
  }                                                                                                                                                                                                        
  ```                                                                                                                                                                                                      
                                                                                                                                                                                                           
  New (calibrated):                                                                                                                                                                                        
  ```rust                                                                                                                                                                                                  
  // Get calibrated signal quality                                                                                                                                                                         
  let flow_ir = calibrated_flow.information_ratio();                                                                                                                                                       
  let flow_is_predictive = flow_ir > 1.0;                                                                                                                                                                  
  let flow_half_life = calibrated_flow.half_life_days();                                                                                                                                                   
                                                                                                                                                                                                           
  // Decision based on measured predictive power                                                                                                                                                           
  if flow_is_predictive {                                                                                                                                                                                  
  // Use the signal - weight skew by IR                                                                                                                                                                    
  let skew_weight = (flow_ir - 1.0).min(1.0);                                                                                                                                                              
  return QuoteBoth {                                                                                                                                                                                       
  skew: flow_imbalance * skew_weight                                                                                                                                                                       
  };                                                                                                                                                                                                       
  } else if flow_half_life < 7.0 {                                                                                                                                                                         
  // Signal is staling - log warning, fall back to symmetric                                                                                                                                               
  warn!("flow_imbalance IR={:.2} < 1.0, half_life={:.1}d - signal is noise",                                                                                                                               
  flow_ir, flow_half_life);                                                                                                                                                                                
  return QuoteBoth { skew: 0.0 };                                                                                                                                                                          
  } else {                                                                                                                                                                                                 
  // Not enough data yet - quote symmetric while measuring                                                                                                                                                 
  return QuoteBoth { skew: 0.0 };                                                                                                                                                                          
  }                                                                                                                                                                                                        
  ```                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ### Phase 3: Wire to LearningModule                                                                                                                                                                      
                                                                                                                                                                                                           
  **File**: `src/market_maker/learning/mod.rs`                                                                                                                                                             
                                                                                                                                                                                                           
  The LearningModule already tracks fill outcomes. Add flow_imbalance to its prediction logging:                                                                                                           
                                                                                                                                                                                                           
  ```rust                                                                                                                                                                                                  
  // In record_pending_prediction()                                                                                                                                                                        
  pub fn record_pending_prediction(&mut self, market_state: &MarketState, ...) {                                                                                                                           
  // Existing: ensemble prediction                                                                                                                                                                         
  let ensemble_pred = self.ensemble.predict(...);                                                                                                                                                          
                                                                                                                                                                                                           
  // NEW: Record flow_imbalance prediction                                                                                                                                                                 
  let flow_pred_id = self.calibrated_flow.predict(                                                                                                                                                         
  market_state.flow_imbalance,                                                                                                                                                                             
  market_state.regime                                                                                                                                                                                      
  );                                                                                                                                                                                                       
                                                                                                                                                                                                           
  self.pending.push(PendingPrediction {                                                                                                                                                                    
  // ... existing fields ...                                                                                                                                                                               
  flow_prediction_id: Some(flow_pred_id),                                                                                                                                                                  
  });                                                                                                                                                                                                      
  }                                                                                                                                                                                                        
                                                                                                                                                                                                           
  // In resolve_prediction()                                                                                                                                                                               
  pub fn resolve_prediction(&mut self, fill: &Fill) {                                                                                                                                                      
  // NEW: Resolve flow_imbalance prediction                                                                                                                                                                
  if let Some(flow_id) = pending.flow_prediction_id {                                                                                                                                                      
  let fill_was_favorable = /* fill direction matched flow sign */;                                                                                                                                         
  self.calibrated_flow.record_outcome(flow_id, fill_was_favorable);                                                                                                                                        
  }                                                                                                                                                                                                        
  }                                                                                                                                                                                                        
  ```                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ### Phase 4: Daily Calibration Report                                                                                                                                                                    
                                                                                                                                                                                                           
  **File**: `src/bin/calibration_report.rs`                                                                                                                                                                
                                                                                                                                                                                                           
  Add flow_imbalance to the daily report:                                                                                                                                                                  
  ```                                                                                                                                                                                                      
  === Flow Imbalance Signal Health ===                                                                                                                                                                     
  Information Ratio: 1.23 (PREDICTIVE)                                                                                                                                                                     
  Brier Score: 0.18 (baseline: 0.25)                                                                                                                                                                       
  Half-Life: 14.2 days                                                                                                                                                                                     
  Samples (24h): 847                                                                                                                                                                                       
  Regime Breakdown:                                                                                                                                                                                        
  - Calm: IR=1.31, n=612                                                                                                                                                                                   
  - Volatile: IR=0.98, n=203  ⚠️ NOISE IN VOLATILE                                                                                                                                                         
  - Cascade: IR=0.71, n=32   ⚠️ NOISE IN CASCADE                                                                                                                                                           
  ```                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ---                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ## Files to Modify                                                                                                                                                                                       
                                                                                                                                                                                                           
  | File | Change |                                                                                                                                                                                        
  |------|--------|                                                                                                                                                                                        
  | `src/market_maker/tracking/calibration_wiring.rs` | Add `CalibratedFlowImbalance` |                                                                                                                    
  | `src/market_maker/control/quote_gate.rs` | Replace threshold with IR check |                                                                                                                           
  | `src/market_maker/learning/mod.rs` | Wire flow predictions to outcome tracking |                                                                                                                       
  | `src/bin/calibration_report.rs` | Add flow_imbalance to daily report |                                                                                                                                 
  | `src/market_maker/core/components.rs` | Add calibrated_flow to MarketMaker |                                                                                                                           
                                                                                                                                                                                                           
  ---                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ## Expected Behavior After Fix                                                                                                                                                                           
                                                                                                                                                                                                           
  1. **First 100 fills**: Quote symmetrically while measuring                                                                                                                                              
  2. **After 100 fills**: Check IR                                                                                                                                                                         
  - IR > 1.0 → Use flow_imbalance for skew, weighted by (IR - 1.0)                                                                                                                                         
  - IR < 1.0 → Log "signal is noise", quote symmetric                                                                                                                                                      
  3. **Ongoing**: Monitor half-life, alert if < 7 days                                                                                                                                                     
  4. **Regime-aware**: May find flow_imbalance predictive in calm but noise in cascade                                                                                                                     
                                                                                                                                                                                                           
  ---                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ## Why This Is Better                                                                                                                                                                                    
                                                                                                                                                                                                           
  | Old (Arbitrary) | New (Calibrated) |                                                                                                                                                                   
  |-----------------|------------------|                                                                                                                                                                   
  | `if signal > 0.15` | `if IR(signal) > 1.0` |                                                                                                                                                           
  | Threshold picked by intuition | Threshold from information theory |                                                                                                                                    
  | Same behavior forever | Adapts as signal quality changes |                                                                                                                                             
  | No feedback loop | Closed-loop measurement |                                                                                                                                                           
  | Doesn't detect staleness | Alerts when alpha decays |                                                                                                                                                  
                                                                                                                                                                                                           
  ---                                                                                                                                                                                                      
                                                                                                                                                                                                           
  ## Verification                                                                                                                                                                                          
                                                                                                                                                                                                           
  1. **Unit test**: Mock fills, verify IR updates correctly                                                                                                                                                
  2. **Paper trade**: Log "IR={:.2}, would_use={}" without changing behavior                                                                                                                               
  3. **Shadow mode**: Run new logic alongside old, compare decisions                                                                                                                                       
  4. **Production**: Enable after 1000+ fills show stable IR       